<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Implementation Planning Environment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base & Theming --- */
        body { font-family: 'Inter', sans-serif; background-color: #F5F5F5; }
        :root {
            --brown-primary: #4E3629; --brown-red: #C00404; --brown-yellow: #FFC72C;
            --brown-gray: #98A4AE; --brown-white: #FFFFFF; --primary-color: var(--brown-primary);
            --secondary-color: var(--brown-gray); --accent-color: var(--brown-yellow);
            --accent-red: var(--brown-red); --text-dark: #3E2723; --text-light: #795548;
            --bg-light: #F5F5F5; --bg-white: var(--brown-white); --border-color: #E0E0E0;
            --success-color: #2E7D32; --warning-color: #AF642B;
        }

        /* --- General Components --- */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease; text-align: center; cursor: pointer; border: 1px solid transparent; }
        .btn-primary { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--text-dark); border-color: var(--text-dark); }
        .btn-secondary { background-color: var(--accent-red); color: white; border-color: var(--accent-red); }
        .btn-secondary:hover { background-color: #A00303; border-color: #A00303;}
        .card { background-color: var(--bg-white); border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05), 0 1px 2px -1px rgb(0 0 0 / 0.05); border: 1px solid var(--border-color); }
        body input, body textarea, body select { border-radius: 0.375rem; border: 1px solid var(--border-color); padding: 0.875rem 1.125rem; width: 100%; background-color: #fff; color: var(--text-dark); }
        body input:focus, body textarea:focus, body select:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(78, 54, 41, 0.3); }
        .d3-tooltip { position: absolute; text-align: left; padding: 8px; font: 12px sans-serif; background: var(--text-dark); color: white; border: 0px; border-radius: 8px; pointer-events: none; opacity: 0; z-index: 1000; max-width: 250px; }
        .info-tip { display: inline-block; margin-left: 4px; color: var(--secondary-color); cursor: help; }
        .info-tip-icon { width: 16px; height: 16px; vertical-align: middle; }
        details summary { list-style: none; cursor: pointer; }
        details summary::-webkit-details-marker { display: none; }
        .details-caret { transition: transform 0.2s; }
        details[open] summary .details-caret { transform: rotate(90deg); }

        /* --- Header & Nav --- */
        .header { background-color: var(--primary-color); }
        .nav-link { transition: color 0.2s, background-color 0.2s; }
        .nav-link.active, .nav-link:hover { color: var(--accent-color); background-color: rgba(0, 0, 0, 0.1); }
        .mobile-nav-link.active { color: var(--accent-color); font-weight: 700; }
        .nav-icon {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            margin-right: 0.5rem; /* 8px */
        }
        
        /* --- Phased Plan Styles --- */
        .epis-phase { position: relative; padding: 2rem 0 2rem 2.5rem; border-left: 4px solid var(--border-color); }
        .epis-phase:last-child { border-left: 4px solid transparent; }
        .epis-phase::before { content: ''; position: absolute; left: -1rem; top: 2.2rem; width: 1.75rem; height: 1.75rem; background-color: var(--bg-white); border: 4px solid var(--border-color); border-radius: 9999px; z-index: 1; }
        .epis-phase.active::before { border-color: var(--accent-red); background-color: var(--accent-color); }
        .module-card { transition: transform 0.2s, box-shadow 0.2s; }
        .module-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .module-status { font-weight: 600; }
        .status-complete { color: var(--success-color); }
        .status-incomplete { color: #6B7280; } /* Grey for Incomplete */
        .status-locked { color: #000000; } /* Black for Locked */
        .page-title { color: var(--accent-red); }
        .section-title { color: var(--primary-color); }

        /* --- Ecosystem Map Styles --- */
        #ecosystem-canvas { background-color: white; border: 1px solid #ddd; border-radius: 0.5rem; overflow: hidden; }
        .actor-node.selected .actor-circle { stroke: var(--accent-red); stroke-width: 4px; }
        .actor-delete-btn { cursor: pointer; opacity: 0; transition: opacity 0.2s ease; }
        .actor-node:hover .actor-delete-btn, .actor-node.selected .actor-delete-btn { opacity: 1; }
        .actor-list-item.selected { background-color: var(--accent-color) !important; border-left: 4px solid var(--primary-color); }

        /* --- CFIR Module Styles --- */
        .cfir-rating-group { display: flex; justify-content: space-between; align-items: center; }
        .cfir-rating-group label { text-align: center; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .cfir-rating-group input[type=radio] { display: none; }
        .cfir-rating-group input[type=radio]:checked + span { font-weight: bold; color: white; }
        .cfir-rating-group input[value="-2"]:checked + span { background-color: #C62828; }
        .cfir-rating-group input[value="-1"]:checked + span { background-color: #E57373; }
        .cfir-rating-group input[value="0"]:checked + span { background-color: #78909C; }
        .cfir-rating-group input[value="1"]:checked + span { background-color: #9CCC65; }
        .cfir-rating-group input[value="2"]:checked + span { background-color: #558B2F; }

        /* --- IRLM Styles --- */
        .irlm-column { background-color: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 0.5rem; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
        .irlm-column-title { font-weight: 700; font-size: 1.1rem; color: var(--primary-color); text-align: center; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 0.5rem; }
        .irlm-subgroup { border: 1px solid #D1D5DB; border-radius: 0.375rem; padding: 0.5rem; }
        .irlm-subgroup-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-light); }
        .irlm-item { background-color: white; border: 1px solid #E5E7EB; padding: 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .irlm-item.barrier { border-left: 4px solid #EF4444; }
        .irlm-item.facilitator { border-left: 4px solid #22C55E; }
        .outcomes-sub-column { display: flex; flex-direction: column; gap: 0.75rem; }

        /* --- Causal Pathway Diagrammer Styles --- */
        #cpd-container { display: flex; flex-direction: column; gap: 1rem; }
        @media (min-width: 1024px) { #cpd-container { flex-direction: row; } }
        #cpd-toolbar { flex: 0 0 auto; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        @media (min-width: 1024px) { #cpd-toolbar { flex: 0 0 220px; } }
        #cpd-toolbar h3 { font-size: 1.1rem; font-weight: 600; color: var(--primary-color); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .cpd-tool-btn { display: flex; align-items: center; width: 100%; padding: 0.6rem 0.75rem; margin-bottom: 0.5rem; border-radius: 0.375rem; background-color: white; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s ease; font-weight: 500; }
        .cpd-tool-btn:hover { background-color: var(--accent-color); border-color: var(--primary-color); color: var(--text-dark); }
        #cpd-canvas-wrapper { flex-grow: 1; position: relative; border: 1px solid var(--border-color); border-radius: 0.5rem; overflow: hidden; background-color: #fdfdfd; }
        #cpd-canvas-svg { width: 100%; height: 700px; cursor: grab; }
        .cpd-node { cursor: move; } .cpd-node:active { cursor: grabbing; }
        .cpd-node-shape { stroke-width: 2px; stroke: var(--primary-color); fill: white; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); transition: stroke 0.2s ease, stroke-width 0.2s ease, fill 0.2s ease; }
        .cpd-node-text { font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 500; fill: var(--text-dark); pointer-events: none; text-anchor: middle; dominant-baseline: middle; }
        .cpd-link { stroke: var(--primary-color); stroke-width: 2px; marker-end: url(#arrow); transition: stroke 0.2s ease; fill: none; }
        .cpd-link-hitbox { stroke: transparent; stroke-width: 12px; cursor: pointer; fill: none; }
        .cpd-link-group:hover .cpd-link { stroke: var(--accent-red); marker-end: url(#arrow-hover); }
        .cpd-node.selected .cpd-node-shape { stroke: var(--primary-color); stroke-width: 4px; }
        .cpd-link-group.selected .cpd-link { stroke: var(--accent-red); stroke-width: 3.5px; marker-end: url(#arrow-selected); }
        .cpd-delete-btn { cursor: pointer; opacity: 0; transition: opacity 0.2s ease; }
        .cpd-node:hover .cpd-delete-btn, .cpd-node.selected .cpd-delete-btn { opacity: 1; }
        .canvas-container .zoom-controls { position: absolute; bottom: 1rem; right: 1rem; z-index: 20; display: flex; gap: 0.5rem; }
        .canvas-container .clear-btn { position: absolute; top: 1rem; right: 1rem; z-index: 20; }

        /* --- Learn Tab & ERIC Strategy Styles --- */
        .learn-card { transition: transform 0.2s, box-shadow 0.2s; }
        .learn-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .learn-content h2 { font-size: 1.75rem; font-weight: 700; color: var(--primary-color); margin-bottom: 1rem; margin-top: 2rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem; }
        .learn-content h3 { font-size: 1.25rem; font-weight: 600; color: var(--text-dark); margin-top: 1.5rem; margin-bottom: 0.75rem; }
        .learn-content p, .learn-content li { line-height: 1.6; margin-bottom: 1rem; color: var(--text-light); }
        .learn-content blockquote { border-left: 4px solid var(--primary-color); padding-left: 1rem; margin: 1.5rem 0; font-style: italic; color: var(--text-dark); }
        .learn-content .citation { font-size: 0.75rem; color: var(--secondary-color); }
        .interactive-quiz .quiz-option { cursor: pointer; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; transition: background-color 0.2s; }
        .interactive-quiz .quiz-option:hover { background-color: #FFFDE7; }
        .interactive-quiz .quiz-option.selected { background-color: var(--accent-color); }
        .interactive-quiz .quiz-option.correct { background-color: #D4EDDA; border-color: #C3E6CB; }
        .interactive-quiz .quiz-option.incorrect { background-color: #F8D7DA; border-color: #F5C6CB; }
        #eric-search-results .strategy-item { border-bottom: 1px solid var(--border-color); }
        .determinant-list { max-height: 600px; overflow-y: auto; }
        .strategy-list { max-height: 600px; overflow-y: auto; }

        /* --- Read-only preview styles --- */
        .read-only-page .btn-primary, .read-only-page .btn-secondary { display: none; }
        .read-only-page input, .read-only-page textarea, .read-only-page select { pointer-events: none; background-color: #ECEFF1; opacity: 0.8; }
        .read-only-page .preview-notice { display: block !important; }

    </style>
</head>
<body class="bg-bg-light text-text-dark">

    <header class="header shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <!-- SVG icon removed from here -->
                    </div>
                    <div class="ml-4">
                        <div id="project-title-header" class="text-lg font-bold text-white leading-tight">New Project</div>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div id="desktop-menu" class="ml-10 flex items-baseline space-x-1">
                        <a id="nav-overview" class="nav-link text-gray-300 px-3 py-2 rounded-md text-sm font-medium flex items-center" onclick="setActiveNav('overview')">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24-.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22-.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path>
                            </svg>
                            Overview
                        </a>
                        <a id="nav-plan" class="nav-link text-gray-300 px-3 py-2 rounded-md text-sm font-medium flex items-center" onclick="setActiveNav('plan')">
                             <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 8C7.33333 8.66667 3.6 10.7 2 13.5M11.5 11C9.16667 12.3333 4 16.4 2 22M12.5 14.5C11.3333 15.6667 8.7 18.6 7.5 21"></path>
                                <path d="M14.6742 6.45067L15.3467 3.16466L17.572 5.67421L20.5992 5.38071L18.8314 8.44258L20.5738 11.0815L17.2878 10.4091L14.7783 12.6344L14.9677 9.47785L11.9059 7.71009L14.6742 6.45067Z"></path>
                            </svg>
                            Plan
                        </a>
                        <a id="nav-dashboard" class="nav-link text-gray-300 px-3 py-2 rounded-md text-sm font-medium flex items-center" onclick="setActiveNav('dashboard')">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"></path></svg>
                            Dashboard
                        </a>
                        <a id="nav-learn" class="nav-link text-gray-300 px-3 py-2 rounded-md text-sm font-medium flex items-center" onclick="setActiveNav('learn')">
                            <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"></path></svg>
                            Learn
                        </a>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" id="mobile-menu-button" class="bg-primary-color inline-flex items-center justify-center p-2 rounded-md text-gray-300 hover:text-white hover:bg-opacity-75 focus:outline-none" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <svg id="menu-open-icon" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        <svg id="menu-close-icon" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
        </div>
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a id="nav-mobile-overview" class="mobile-nav-link text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center" onclick="setActiveNav('overview')">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24-.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22-.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path>
                    </svg>
                    Overview
                </a>
                <a id="nav-mobile-plan" class="mobile-nav-link text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center" onclick="setActiveNav('plan')">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 8C7.33333 8.66667 3.6 10.7 2 13.5M11.5 11C9.16667 12.3333 4 16.4 2 22M12.5 14.5C11.3333 15.6667 8.7 18.6 7.5 21"></path>
                        <path d="M14.6742 6.45067L15.3467 3.16466L17.572 5.67421L20.5992 5.38071L18.8314 8.44258L20.5738 11.0815L17.2878 10.4091L14.7783 12.6344L14.9677 9.47785L11.9059 7.71009L14.6742 6.45067Z"></path>
                    </svg>
                    Plan
                </a>
                <a id="nav-mobile-dashboard" class="mobile-nav-link text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center" onclick="setActiveNav('dashboard')">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"></path></svg>
                    Dashboard
                </a>
                <a id="nav-mobile-learn" class="mobile-nav-link text-gray-300 hover:text-white block px-3 py-2 rounded-md text-base font-medium flex items-center" onclick="setActiveNav('learn')">
                    <svg class="nav-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"></path></svg>
                    Learn
                </a>
            </div>
        </div>
    </header>

    <main id="app" class="container mx-auto p-4 sm:p-6 md:p-8">
        <!-- Main content pages will be injected here -->
        <div id="overview" class="fade-in"></div>
        <div id="plan" class="hidden fade-in"></div>
        <div id="dashboard" class="hidden fade-in"></div>
        <div id="learn" class="hidden fade-in"></div>

        <!-- Individual Tool Module Pages -->
        <div id="page-usable-innovation" class="hidden fade-in"></div>
        <div id="page-ecosystem-mapper" class="hidden fade-in"></div>
        <div id="page-cfir-diagnostic" class="hidden fade-in"></div>
        <div id="page-barrier-prioritizer" class="hidden fade-in"></div>
        <div id="page-readiness-assessor" class="hidden fade-in"></div>
        <div id="page-explore-eric-strategies" class="hidden fade-in"></div>
        <div id="page-irlm" class="hidden fade-in"></div>
        <div id="page-behavioral-diagnosis" class="hidden fade-in"></div>
        <div id="page-fidelity-planner" class="hidden fade-in"></div>
        <div id="page-costing-planner" class="hidden fade-in"></div>
        <div id="page-causal-pathway-diagrammer" class="hidden fade-in"></div>
        <div id="page-adaptations-tracker" class="hidden fade-in"></div>
        <div id="page-pdsa-tracker" class="hidden fade-in"></div>
        <div id="page-outcomes-planner" class="hidden fade-in"></div>
        <div id="page-npt-monitor" class="hidden fade-in"></div>
        <div id="page-sustainment-planner" class="hidden fade-in"></div>
        
    </main>

    <!-- Modals -->
    <div id="modal-container"></div>


    <script>
        // --- DATA & STATE MANAGEMENT ---
        let projectData = {
            projectName: "New Project",
            projectStatus: {
                'usable-innovation': 'incomplete', 'ecosystem-mapper': 'incomplete', 'cfir-diagnostic': 'incomplete',
                'barrier-prioritizer': 'incomplete', 'readiness-assessor': 'incomplete', 'explore-eric-strategies': 'incomplete', 'irlm': 'incomplete', 'behavioral-diagnosis': 'incomplete',
                'fidelity-planner': 'incomplete', 'costing-planner': 'incomplete', 
                'causal-pathway-diagrammer': 'incomplete',
                'outcomes-planner': 'incomplete', 'adaptations-tracker': 'incomplete', 'pdsa-tracker': 'incomplete',
                'npt-monitor': 'incomplete', 'sustainment-planner': 'incomplete',
            },
            usableInnovation: { 
                practiceName: "", 
                description: "", 
                components: [],
                projectTeam: []
            },
            ecosystemActors: [],
            ecosystemConnections: [],
            cfirAssessment: { 
                ratings: {}, 
                risks: [] 
            },
            barriers: [],
            readinessAssessment: { commitment: 50, efficacy: 50, commitmentNotes: "", efficacyNotes: "" },
            irlm: { 
                strategies: [], 
                mechanisms: [] 
            },
            behavioralDiagnosis: { diagnoses: [] },
            cpdNodes: [],
            cpdConnections: [],
            adaptations: [],
            pdsaCycles: [],
            outcomes: {
                logicModel: { 
                    implementation: [], 
                    service: [], 
                    client: [] 
                },
                reAim: {
                    reach: { metric: "", target: "", notes: "" }, 
                    effectiveness: { metric: "", target: "", notes: "" },
                    adoption: { metric: "", target: "", notes: "" }, 
                    implementation: { metric: "", target: "", notes: "" },
                    maintenance: { metric: "", target: "", notes: "" },
                }
            },
            nptAssessment: { 
                coherence: "", 
                cognitiveParticipation: "", 
                collectiveAction: "", 
                reflexiveMonitoring: "" 
            },
            sustainmentPlan: { 
                funding: "", 
                workforce: "", 
                monitoring: "", 
                adaptation: "", 
                policy: "" 
            },
            costingPlan: { activities: [] },
            finalEvaluationSummary: "" 
        };

        // --- GLOBAL VARIABLES ---
        let infoTooltip, barrierTooltip, ecosystemTooltip, selectedActorId = null;
        // CPD Globals
        let cpdSvg, cpdZoom, cpdG, selectedCpdNodeId = null, selectedCpdLinkId = null;

        // --- INITIALIZATION & PAGE ROUTING ---
        document.addEventListener('DOMContentLoaded', () => {
            infoTooltip = d3.select("body").append("div").attr("class", "d3-tooltip");
            barrierTooltip = d3.select("body").append("div").attr("class", "d3-tooltip");
            ecosystemTooltip = d3.select("body").append("div").attr("class", "d3-tooltip");
            
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const openIcon = document.getElementById('menu-open-icon');
            const closeIcon = document.getElementById('menu-close-icon');

            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                openIcon.classList.toggle('hidden');
                closeIcon.classList.toggle('hidden');
            });

            setActiveNav('overview');
        });

        function setActiveNav(pageId) {
            document.getElementById('mobile-menu').classList.add('hidden');
            document.getElementById('menu-open-icon').classList.remove('hidden');
            document.getElementById('menu-close-icon').classList.add('hidden');
            document.querySelectorAll('#desktop-menu .nav-link').forEach(link => link.classList.remove('active'));
            document.getElementById(`nav-${pageId}`).classList.add('active');
            document.querySelectorAll('#mobile-menu .mobile-nav-link').forEach(link => link.classList.remove('active'));
            document.getElementById(`nav-mobile-${pageId}`).classList.add('active');
            showPage(pageId);
        }

        function showPage(pageId, fromPage = null, isPreview = false) {
            // Cleanup listeners from previous page if it was the CPD tool
            if (document.getElementById('page-causal-pathway-diagrammer').classList.contains('hidden') === false) {
                cleanupCpdListeners();
            }

            document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
            const page = document.getElementById(pageId);
            if (page) {
                page.classList.remove('hidden');
                page.classList.toggle('read-only-page', isPreview);
                window.scrollTo(0, 0);
                renderPageContent(pageId, fromPage, isPreview);
            }
        }

        function createBackLink(targetPage) {
            return `<a href="#" onclick="event.preventDefault(); showPage('${targetPage}')" class="inline-flex items-center text-sm font-medium text-text-light hover:text-primary-color mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Back to Plan
                    </a>`;
        }
        
        function createLearnBackLink() {
             return `<a href="#" onclick="event.preventDefault(); renderLearn()" class="inline-flex items-center text-sm font-medium text-text-light hover:text-primary-color mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Back to Learn Hub
                    </a>`;
        }

        function createPreviewNotice() {
            return `<div class="preview-notice hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-r-lg" role="alert">
                        <p class="font-bold">Preview Mode</p>
                        <p>This module is locked. Complete previous phases in the Plan to unlock editing and saving capabilities.</p>
                    </div>`;
        }
        
        function renderPageContent(pageId, fromPage, isPreview) {
            const container = document.getElementById(pageId);
            if (!container) return;
            
            // Only clear content if it's not a learn sub-page, as they manage their own content.
            if (!pageId.startsWith('learn-')) {
                 container.innerHTML = ''; 
            }

            switch(pageId) {
                case 'overview': renderOverview(); break;
                case 'plan': renderEpisPlan(); break;
                case 'dashboard': renderDashboard(); break;
                case 'learn': renderLearn(); break;
                case 'page-usable-innovation': renderUsableInnovation(); break;
                case 'page-ecosystem-mapper': renderEcosystemMapper(); break;
                case 'page-cfir-diagnostic': renderCfirDiagnostic(); break;
                case 'page-barrier-prioritizer': renderBarrierPrioritizer(); break;
                case 'page-readiness-assessor': renderReadinessAssessor(); break;
                case 'page-explore-eric-strategies': renderExploreEricStrategies(); break;
                case 'page-irlm': renderIRLM(); break;
                case 'page-behavioral-diagnosis': renderBehavioralDiagnosis(); break;
                case 'page-fidelity-planner': renderFidelityPlanner(); break;
                case 'page-costing-planner': renderCostingPlanner(); break;
                case 'page-causal-pathway-diagrammer': renderCausalPathwayDiagrammer(); break;
                case 'page-adaptations-tracker': renderAdaptationsTracker(); break;
                case 'page-pdsa-tracker': renderPDSATracker(); break;
                case 'page-outcomes-planner': renderOutcomesPlanner(); break;
                case 'page-npt-monitor': renderNPTMonitor(); break;
                case 'page-sustainment-planner': renderSustainmentPlanner(); break;
            }
            addInfoTipListeners();
        }

        // --- OVERVIEW PAGE ---
        function renderOverview() {
            const container = document.getElementById('overview');
            container.innerHTML = `
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Implementation Project Overview</h1>
                    <p class="text-text-light mb-6">This tool guides the process of planning, implementing, and sustaining a new practice or program.</p>
                    <div class="space-y-4 max-w-2xl">
                        <div>
                            <label for="project-name-input" class="block font-medium text-sm text-text-light">Project Name</label>
                            <input type="text" id="project-name-input" class="mt-1" value="${projectData.projectName}">
                        </div>
                        <div>
                            <label for="final-eval-summary" class="block font-medium text-sm text-text-light">Organizational Learning: Insights from Previous Projects</label>
                            <textarea id="final-eval-summary" rows="4" class="mt-1" placeholder="If this project builds on a previous one, summarize the key evaluation findings and lessons learned here. This creates a cyclical learning process.">${projectData.finalEvaluationSummary}</textarea>
                        </div>
                    </div>

                    <div class="border-t pt-6 mt-6">
                        <div class="flex items-center mb-3">
                            <h2 class="text-xl font-bold section-title mr-4">Project Team</h2>
                            <button class="btn btn-secondary text-sm" onclick="addProjectTeamMember()">Add Member</button>
                        </div>
                        <div id="team-list" class="space-y-3"></div>
                    </div>

                    <div class="mt-8 flex justify-end">
                        <button class="btn btn-primary" onclick="setActiveNav('plan')">Go to Implementation Plan &rarr;</button>
                    </div>
                </div>`;
            
            document.getElementById('project-name-input').addEventListener('change', (e) => {
                projectData.projectName = e.target.value;
                document.getElementById('project-title-header').textContent = projectData.projectName || "New Project";
            });
            document.getElementById('final-eval-summary').addEventListener('change', e => projectData.finalEvaluationSummary = e.target.value);
            document.getElementById('project-title-header').textContent = projectData.projectName || "New Project";
            renderProjectTeam();
        }

        // --- EPIS PLAN ---
        function renderEpisPlan() {
            const container = document.getElementById('plan');
            const phases = [
                { name: 'Exploration', modules: ['usable-innovation', 'ecosystem-mapper', 'cfir-diagnostic', 'barrier-prioritizer', 'readiness-assessor'] },
                { name: 'Preparation', modules: ['explore-eric-strategies', 'irlm', 'behavioral-diagnosis', 'fidelity-planner', 'costing-planner', 'outcomes-planner', 'causal-pathway-diagrammer'] },
                { name: 'Implementation', modules: ['adaptations-tracker', 'pdsa-tracker'] },
                { name: 'Sustainment', modules: ['npt-monitor', 'sustainment-planner'] }
            ];

            const allModules = {
                'usable-innovation': { title: 'Define the Project', desc: 'Clearly state what is being implemented and what its essential pieces are.' },
                'ecosystem-mapper': { title: 'Map the Ecosystem', desc: 'Identify and analyze the key actors, their influence, and their relationships.' },
                'cfir-diagnostic': { title: 'Assess the Context', desc: 'Identify potential barriers and strengths in the environment using the CFIR framework.' },
                'barrier-prioritizer': { title: 'Prioritize Barriers', desc: 'Systematically identify and prioritize implementation barriers to focus efforts.' },
                'readiness-assessor': { title: 'Assess Readiness for Change', desc: 'Measure the organization\'s shared commitment and confidence to make this change.' },
                'explore-eric-strategies': { title: 'Explore ERIC Strategies', desc: 'Select evidence-based strategies to address prioritized determinants.'},
                'irlm': { title: 'Implementation Research Logic Model', desc: 'Visually map the pathway from determinants to outcomes, linking them with strategies.' },
                'behavioral-diagnosis': { title: 'Understand Behavior Change', desc: 'Figure out what might prevent people from adopting the new practice using the COM-B model.' },
                'fidelity-planner': { title: 'Plan for Fidelity', desc: 'Define the core components of the EBP and plan how to measure them.' },
                'costing-planner': { title: 'Plan for Costs', desc: 'Use activity-based costing to budget for implementation strategies.' },
                'causal-pathway-diagrammer': { title: 'Causal Pathway Diagram', desc: 'Map the causal links between strategies, mechanisms, and outcomes.' },
                'outcomes-planner': { title: 'Define & Measure Success', desc: 'Decide what success looks like and how it will be measured (using Proctor and RE-AIM frameworks).' },
                'adaptations-tracker': { title: 'Track Changes', desc: 'Keep a log of any changes or adaptations made to the plan along the way.' },
                'pdsa-tracker': { title: 'Test & Refine (PDSA)', desc: 'Run small tests of change to learn and improve the approach.' },
                'npt-monitor': { title: 'Track Long-Term Adoption', desc: 'Check how well the new practice is becoming a normal part of work.' },
                'sustainment-planner': { title: 'Plan for the Future', desc: 'Develop a plan to make sure the new practice lasts over the long term.' }
            };

            let previousPhaseComplete = true;

            container.innerHTML = `
                <h1 class="text-4xl font-bold text-center page-title mb-2">Implementation Plan</h1>
                <p class="text-center text-text-light mb-12 max-w-3xl mx-auto">This workflow guides users through the four phases of implementation. Modules in later phases unlock as earlier ones are completed, but can be previewed at any time.</p>
                <div class="max-w-4xl mx-auto">
                    ${phases.map(phase => {
                        const phaseModules = phase.modules;
                        const isPhaseComplete = phaseModules.every(id => projectData.projectStatus[id] === 'complete');
                        const isLocked = !previousPhaseComplete;
                        
                        const phaseHtml = `
                        <div class="epis-phase ${!isLocked ? 'active' : ''}">
                            <h2 class="text-3xl font-bold section-title mb-6">${phase.name}</h2>
                            <div class="grid md:grid-cols-2 gap-6">
                                ${phaseModules.map(id => {
                                    const module = allModules[id];
                                    const status = projectData.projectStatus[id];
                                    const clickAction = isLocked 
                                        ? `showPage('page-${id}', 'plan', true)` 
                                        : `showPage('page-${id}', 'plan', false)`;
                                    
                                    let statusText, statusClass;
                                    if (isLocked) {
                                        statusText = 'üîí Locked';
                                        statusClass = 'status-locked';
                                    } else if (status === 'complete') {
                                        statusText = '‚úÖ Complete';
                                        statusClass = 'status-complete';
                                    } else {
                                        statusText = '‚òëÔ∏è Incomplete';
                                        statusClass = 'status-incomplete';
                                    }

                                    return `
                                    <div class="card module-card cursor-pointer" onclick="${clickAction}">
                                        <div class="p-6">
                                            <h3 class="text-xl font-semibold section-title">${module.title}</h3>
                                            <p class="text-sm text-text-light mt-2 mb-4 h-12">${module.desc}</p>
                                            <div class="flex justify-between items-center">
                                                <span class="module-status ${statusClass}">
                                                    ${statusText}
                                                </span>
                                                <span class="text-primary-color font-semibold">${isLocked ? '‚Ä∫' : '‚Ä∫'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>`;
                        
                        if (!isLocked) {
                            previousPhaseComplete = isPhaseComplete;
                        }
                        
                        return phaseHtml;
                    }).join('')}
                </div>`;
        }
        
        // --- MODULE: Usable Innovation ---
        function renderUsableInnovation() {
            const container = document.getElementById('page-usable-innovation');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Define the Project</h1>
                    <p class="text-text-light mb-6">Clearly defining the new practice or program is the first step. Distinguish between its non-negotiable "core" parts and the parts that can be adapted.</p>
                    <div class="space-y-6">
                        <div>
                            <label class="block font-semibold">Practice or Program Name</label>
                            <input type="text" id="practice-name" placeholder="e.g., Cognitive Behavioral Therapy for Anxiety" value="${projectData.usableInnovation.practiceName}" onchange="projectData.usableInnovation.practiceName = this.value">
                        </div>
                        <div>
                            <label class="block font-semibold">Brief Description</label>
                            <textarea id="practice-desc" rows="3" placeholder="Describe the practice, its goals, and target population." onchange="projectData.usableInnovation.description = this.value">${projectData.usableInnovation.description}</textarea>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <h2 class="text-xl font-bold section-title">Components</h2>
                                <button class="btn btn-secondary text-sm" onclick="addInnovationComponent()">Add Component</button>
                            </div>
                            <div id="components-list" class="space-y-3"></div>
                        </div>
                    </div>
                     <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('usable-innovation')">Save and Mark as Complete</button>
                    </div>
                </div>`;
            renderInnovationComponents();
        }

        function renderInnovationComponents() {
            const list = document.getElementById('components-list');
            if (!list) return;
            if (projectData.usableInnovation.components.length === 0) {
                list.innerHTML = `<p class="text-center text-text-light p-4 bg-bg-light rounded-md">No components defined yet. Click "Add Component" to start.</p>`;
                return;
            }
            list.innerHTML = projectData.usableInnovation.components.map(c => `
                <div class="bg-bg-light p-4 rounded-lg border border-border-color">
                    <div class="flex justify-end"><button class="text-red-500 hover:text-red-700 font-semibold text-xl" onclick="deleteInnovationComponent(${c.id})">&times;</button></div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label class="block font-semibold text-sm">Component Name</label><input type="text" value="${c.name}" onchange="updateInnovationComponent(${c.id}, 'name', this.value)"></div>
                        <div><label class="block font-semibold text-sm">Component Type</label><select onchange="updateInnovationComponent(${c.id}, 'type', this.value)"><option value="core" ${c.type === 'core' ? 'selected' : ''}>Core (Non-Negotiable)</option><option value="adaptable" ${c.type === 'adaptable' ? 'selected' : ''}>Adaptable (Can be modified)</option></select></div>
                    </div>
                    <div class="mt-3"><label class="block font-semibold text-sm">Description</label><textarea rows="2" onchange="updateInnovationComponent(${c.id}, 'description', this.value)">${c.description}</textarea></div>
                </div>`).join('');
        }
        
        function addInnovationComponent() {
            projectData.usableInnovation.components.push({ id: Date.now(), name: "New Component", description: "", type: 'core' });
            renderInnovationComponents();
        }

        function updateInnovationComponent(id, field, value) {
            const component = projectData.usableInnovation.components.find(c => c.id === id);
            if(component) component[field] = value;
        }
        
        function deleteInnovationComponent(id) {
            projectData.usableInnovation.components = projectData.usableInnovation.components.filter(c => c.id !== id);
            renderInnovationComponents();
        }

        function renderProjectTeam() {
            const list = document.getElementById('team-list');
            if (!list) return;
            if (projectData.usableInnovation.projectTeam.length === 0) {
                list.innerHTML = `<p class="text-center text-text-light p-4 bg-bg-light rounded-md">No team members defined yet. Click "Add Member" to start.</p>`;
                return;
            }
            list.innerHTML = projectData.usableInnovation.projectTeam.map(m => `
                <div class="bg-bg-light p-4 rounded-lg border border-border-color">
                    <div class="flex justify-end"><button class="text-red-500 hover:text-red-700 font-semibold text-xl" onclick="deleteProjectTeamMember(${m.id})">&times;</button></div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label class="block font-semibold text-sm">Name</label><input type="text" value="${m.name}" onchange="updateProjectTeamMember(${m.id}, 'name', this.value)"></div>
                        <div><label class="block font-semibold text-sm">Role</label><input type="text" value="${m.role}" onchange="updateProjectTeamMember(${m.id}, 'role', this.value)"></div>
                    </div>
                    <div class="mt-3"><label class="block font-semibold text-sm">Responsibilities</label><textarea rows="2" onchange="updateProjectTeamMember(${m.id}, 'responsibilities', this.value)">${m.responsibilities}</textarea></div>
                </div>`).join('');
        }

        function addProjectTeamMember() {
            projectData.usableInnovation.projectTeam.push({ id: Date.now(), name: "", role: "", responsibilities: "" });
            renderProjectTeam();
        }

        function updateProjectTeamMember(id, field, value) {
            const member = projectData.usableInnovation.projectTeam.find(m => m.id === id);
            if (member) member[field] = value;
        }

        function deleteProjectTeamMember(id) {
            projectData.usableInnovation.projectTeam = projectData.usableInnovation.projectTeam.filter(m => m.id !== id);
            renderProjectTeam();
        }
        
        // --- MODULE: Ecosystem Mapper ---
        function renderEcosystemMapper() {
            const container = document.getElementById('page-ecosystem-mapper');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Ecosystem Map</h1>
                    <p class="text-text-light mb-6">Identify key actors, map their relationships, and analyze their influence on and interest in the project. Drag nodes to move. Shift-drag from node to node to create a link.</p>
                    <div class="grid lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-4 bg-white p-6 rounded-lg shadow-inner border">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold section-title">Actors</h3>
                                <button onclick="openActorModal(null)" class="btn btn-secondary text-sm">Add New</button>
                            </div>
                            <div id="ecosystem-actor-list" class="space-y-2 h-[550px] overflow-y-auto pr-2"></div>
                        </div>
                        <div class="lg:col-span-8 bg-white p-2 rounded-lg shadow-inner border relative">
                            <div id="ecosystem-canvas" class="w-full h-[600px]">
                                <svg id="ecosystem-svg-layer" class="w-full h-full"></svg>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('ecosystem-mapper')">Save and Mark as Complete</button>
                    </div>
                </div>`;
            renderEcosystemActorList();
            requestAnimationFrame(renderEcosystemMap);
        }

        function renderEcosystemActorList() {
            const listContainer = document.getElementById('ecosystem-actor-list');
            if (!listContainer) return;
            listContainer.innerHTML = projectData.ecosystemActors.length === 0 
                ? '<p class="text-sm text-gray-500 text-center mt-4">No actors added yet. Click "Add New" to start.</p>'
                : projectData.ecosystemActors.map(actor => `
                    <div id="actor-list-item-${actor.id}" class="actor-list-item p-3 rounded-md border border-gray-200 hover:bg-yellow-50 flex justify-between items-center cursor-pointer ${actor.id === selectedActorId ? 'selected' : ''}" onclick="highlightActorOnMap(${actor.id})">
                        <div>
                            <p class="font-semibold text-primary-color">${actor.text}</p>
                            <p class="text-xs text-text-light">Influence: ${Math.round(actor.influence)} | Interest: ${Math.round(actor.interest)}</p>
                        </div>
                        <button onclick="event.stopPropagation(); openActorModal(${actor.id})" class="text-gray-400 hover:text-accent-red p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg>
                        </button>
                    </div>
                `).join('');
        }
        
        function highlightActorOnMap(actorId) {
            selectedActorId = selectedActorId === actorId ? null : actorId; // Toggle selection
            renderEcosystemActorList(); 
            d3.select("#ecosystem-svg-layer").selectAll("g.actor-node")
                .classed('selected', d => d.id === selectedActorId);
        }

        function renderEcosystemMap() {
            const canvas = d3.select("#ecosystem-canvas");
            if (canvas.node() === null) return;
            const svg = d3.select("#ecosystem-svg-layer");
            svg.selectAll("*").remove();

            const bounds = canvas.node().getBoundingClientRect();
            if (bounds.width === 0) { requestAnimationFrame(renderEcosystemMap); return; }

            const width = bounds.width;
            const height = bounds.height;
            const margin = {top: 40, right: 40, bottom: 50, left: 60};

            const x = d3.scaleLinear().domain([0, 100]).range([margin.left, width - margin.right]);
            const y = d3.scaleLinear().domain([0, 100]).range([height - margin.bottom, margin.top]);
            const sizeScale = d3.scaleSqrt().domain([1, 200]).range([8, 40]);
            const opacityScale = d3.scaleLinear().domain([0, 100]).range([0.4, 1.0]);
            const color = d3.scaleOrdinal().domain(["high", "medium", "low"]).range(["#2E7D32", "#FFC107", "#C62828"]);
            
            svg.append("g").attr("transform", `translate(0, ${height - margin.bottom})`).call(d3.axisBottom(x).ticks(5));
            svg.append("g").attr("transform", `translate(${margin.left}, 0)`).call(d3.axisLeft(y).ticks(5));
            svg.append("text").attr("text-anchor", "middle").attr("x", width / 2).attr("y", height - 10).text("Interest / Stake in Project ‚Üí").style("font-size", "12px").attr("fill", "var(--text-light)");
            svg.append("text").attr("text-anchor", "middle").attr("transform", "rotate(-90)").attr("y", 20).attr("x", -height / 2).text("Influence / Power ‚Üí").style("font-size", "12px").attr("fill", "var(--text-light)");

            const lines = svg.append("g").attr("class", "connections");
            const actors = svg.append("g").attr("class", "actors");
            let tempLink = null;

            const drag = d3.drag()
                .on("start", function(event, d) {
                    if (event.sourceEvent.shiftKey) {
                        const startCoords = [x(d.interest), y(d.influence)];
                        tempLink = lines.append('line')
                            .attr('class', 'temp-link')
                            .attr('x1', startCoords[0]).attr('y1', startCoords[1])
                            .attr('x2', event.x).attr('y2', event.y)
                            .attr('stroke', 'var(--primary-color)').attr('stroke-width', 2).attr('stroke-dasharray', '5,5');
                    } else {
                        highlightActorOnMap(d.id);
                        d3.select(this).raise().style("cursor", "grabbing");
                    }
                })
                .on("drag", function(event, d) {
                    if (tempLink) {
                        tempLink.attr('x2', event.x).attr('y2', event.y);
                    } else {
                        d.interest = Math.max(0, Math.min(100, x.invert(event.x)));
                        d.influence = Math.max(0, Math.min(100, y.invert(event.y)));
                        d3.select(this).attr('transform', `translate(${x(d.interest)}, ${y(d.influence)})`);
                        updateEcosystemLinks();
                    }
                })
                .on("end", function(event, d) {
                    if (tempLink) {
                        tempLink.remove(); tempLink = null;
                        const endNodeEl = event.sourceEvent.target.closest('.actor-node');
                        if (endNodeEl) {
                            const endNodeData = d3.select(endNodeEl).datum();
                            if (endNodeData && endNodeData.id !== d.id) {
                                const linkExists = projectData.ecosystemConnections.some(l => (l.from === d.id && l.to === endNodeData.id) || (l.from === endNodeData.id && l.to === d.id));
                                if (!linkExists) {
                                    projectData.ecosystemConnections.push({ from: d.id, to: endNodeData.id });
                                    updateEcosystemLinks();
                                }
                            }
                        }
                    } else {
                        d3.select(this).style("cursor", "grab");
                        renderEcosystemActorList();
                    }
                });

            const actorGroups = actors.selectAll("g.actor-node")
                .data(projectData.ecosystemActors, d => d.id).join("g")
                .attr("class", d => `actor-node ${d.id === selectedActorId ? 'selected' : ''}`)
                .attr("transform", d => `translate(${x(d.interest)}, ${y(d.influence)})`)
                .style("opacity", d => opacityScale(d.familiarity))
                .call(drag);

            actorGroups.append("circle")
                .attr("class", "actor-circle")
                .attr("r", d => d.type === 'group' ? sizeScale(d.groupSize) : 8)
                .attr("fill", d => d.type === 'individual' ? d3.color(color(d.willingness)).darker(0.7) : color(d.willingness))
                .attr("stroke", d => d3.color(color(d.willingness)).darker(0.7))
                .attr("stroke-width", 2).style("cursor", "grab");
            
            const deleteBtn = actorGroups.append('g')
                .attr('class', 'actor-delete-btn')
                .on('click', (event, d) => { event.stopPropagation(); deleteActor(d.id); });
            deleteBtn.append('circle').attr('r', 9).attr('fill', 'var(--accent-red)').attr('stroke', 'white').attr('stroke-width', 1.5);
            deleteBtn.append('text').attr('fill', 'white').attr('text-anchor', 'middle').attr('dominant-baseline', 'middle').attr('font-size', '12px').attr('font-weight', 'bold').text('√ó');
            deleteBtn.attr('transform', d => {
                const radius = (d.type === 'group' ? sizeScale(d.groupSize) : 8) + 2;
                return `translate(${radius * 0.707}, ${-radius * 0.707})`;
            });

            actorGroups.on("mouseover", (event, d) => {
                ecosystemTooltip.transition().duration(200).style("opacity", .9);
                ecosystemTooltip.html(`
                    <strong>${d.text}</strong><br/>
                    Influence: ${Math.round(d.influence)}<br/>
                    Interest: ${Math.round(d.interest)}<br/>
                    Familiarity: ${Math.round(d.familiarity)}<br/>
                    Willingness: <span style="text-transform: capitalize;">${d.willingness}</span>
                `)
                .style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 28) + "px");
            }).on("mouseout", () => {
                ecosystemTooltip.transition().duration(500).style("opacity", 0);
            }).on("click", (event, d) => {
                highlightActorOnMap(d.id);
            });
            
            function getLinkEdgePoint(sourceCenter, targetCenter, sourceRadius) {
                const dx = targetCenter.x - sourceCenter.x;
                const dy = targetCenter.y - sourceCenter.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist === 0) return sourceCenter;
                return { x: sourceCenter.x + (dx * sourceRadius) / dist, y: sourceCenter.y + (dy * sourceRadius) / dist };
            }

            function updateEcosystemLinks() {
                const linksData = projectData.ecosystemConnections.filter(c => 
                    projectData.ecosystemActors.some(a => a.id === c.from) && projectData.ecosystemActors.some(a => a.id === c.to)
                );
                lines.selectAll("line.connection-line").data(linksData).join("line")
                    .attr("class", "connection-line")
                    .each(function(d) {
                        const sourceNode = projectData.ecosystemActors.find(a => a.id === d.from);
                        const targetNode = projectData.ecosystemActors.find(a => a.id === d.to);
                        if (!sourceNode || !targetNode) {
                            d3.select(this).remove();
                            return;
                        }
                        const sourceCenter = { x: x(sourceNode.interest), y: y(sourceNode.influence) };
                        const targetCenter = { x: x(targetNode.interest), y: y(targetNode.influence) };
                        const sourceRadius = sourceNode.type === 'group' ? sizeScale(sourceNode.groupSize) : 8;
                        const targetRadius = targetNode.type === 'group' ? sizeScale(targetNode.groupSize) : 8;
                        
                        const sourcePoint = getLinkEdgePoint(sourceCenter, targetCenter, sourceRadius);
                        const targetPoint = getLinkEdgePoint(targetCenter, sourceCenter, targetRadius);

                        d3.select(this).attr("x1", sourcePoint.x).attr("y1", sourcePoint.y)
                                        .attr("x2", targetPoint.x).attr("y2", targetPoint.y);
                    })
                    .attr("stroke", "#aaa").attr("stroke-width", 2);
            }
            updateEcosystemLinks();
        }

        function openActorModal(actorId) {
            const isNew = actorId === null;
            const actor = isNew 
                ? { id: null, text: "", type: 'group', groupSize: 10, influence: 50, interest: 50, willingness: 'medium', familiarity: 50 }
                : projectData.ecosystemActors.find(a => a.id === actorId);

            if (!actor && !isNew) return;
            
            const createSliderRow = (criterion, label, value, tip) => `<div><label class="block font-semibold">${label} ${createInfoTip(tip)} <span class="font-normal text-gray-500" id="actor-${criterion}-value">${value}</span></label><input type="range" min="1" max="100" value="${value}" name="${criterion}" class="w-full mt-1 accent-red-cardinal" oninput="document.getElementById('actor-${criterion}-value').textContent = this.value"></div>`;

            const modalHTML = `
            <div id="actor-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-[100]">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-full overflow-y-auto">
                     <div class="p-6 border-b"><h2 class="text-2xl font-bold page-title">${isNew ? 'Add New Actor' : 'Edit Actor'}</h2></div>
                     <div class="p-6 space-y-4">
                         <input type="hidden" id="current-actor-id" value="${actorId || ''}">
                         <div><label class="block font-semibold">Actor Name</label><input type="text" id="actor-text-input" class="w-full border rounded-md" value="${actor.text}"></div>
                         <div><label>Actor Type</label><select id="edit-actor-type" class="w-full border rounded-md"><option value="group" ${actor.type === 'group' ? 'selected' : ''}>Group</option><option value="individual" ${actor.type === 'individual' ? 'selected' : ''}>Individual</option></select></div>
                         <div id="edit-group-size-container" class="${actor.type === 'group' ? '' : 'hidden'}"><label>Group Size ${createInfoTip("Affects the size of the circle on the map.")}</label><input type="number" id="edit-actor-group-size" value="${actor.groupSize}" class="w-full border rounded-md"></div>
                         ${createSliderRow('influence', 'Influence (Power)', Math.round(actor.influence), "Actor's ability to affect project outcomes.")}
                         ${createSliderRow('interest', 'Interest (Stake)', Math.round(actor.interest), "How much the actor is affected by the project.")}
                         ${createSliderRow('familiarity', 'Familiarity with Project', Math.round(actor.familiarity), "How aware the actor is of the project. Affects opacity.")}
                         <div><label>Willingness to Engage ${createInfoTip("Affects the color of the circle.")}</label><select id="edit-actor-willingness" class="w-full border rounded-md"><option value="high" ${actor.willingness === 'high' ? 'selected' : ''}>High</option><option value="medium" ${actor.willingness === 'medium' ? 'selected' : ''}>Medium</option><option value="low" ${actor.willingness === 'low' ? 'selected' : ''}>Low</option></select></div>
                     </div>
                     <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2">
                         <button type="button" class="btn bg-gray-200 text-gray-700" onclick="closeModal('actor-modal')">Cancel</button>
                         <button type="button" class="btn btn-primary" onclick="saveActorDetails()">${isNew ? 'Add Actor' : 'Save Changes'}</button>
                     </div>
                </div>
            </div>`;
            document.getElementById('modal-container').innerHTML = modalHTML;
            document.getElementById('edit-actor-type').addEventListener('change', (e) => {
                document.getElementById('edit-group-size-container').style.display = e.target.value === 'group' ? 'block' : 'none';
            });
            addInfoTipListeners();
        }

        function saveActorDetails() {
            const actorId = document.getElementById('current-actor-id').value;
            const isNew = actorId === '';
            let actor = isNew ? { id: Date.now() } : projectData.ecosystemActors.find(a => a.id == actorId);
            if (!actor) return;

            actor.text = document.getElementById('actor-text-input').value;
            if (!actor.text.trim()) { alert("Please enter a name for the actor."); return; }
            actor.type = document.getElementById('edit-actor-type').value;
            actor.groupSize = parseInt(document.getElementById('edit-actor-group-size').value) || 1;
            actor.influence = parseInt(document.querySelector('input[name="influence"]').value);
            actor.interest = parseInt(document.querySelector('input[name="interest"]').value);
            actor.familiarity = parseInt(document.querySelector('input[name="familiarity"]').value);
            actor.willingness = document.getElementById('edit-actor-willingness').value;

            if (isNew) projectData.ecosystemActors.push(actor);
            closeModal('actor-modal');
            renderEcosystemActorList();
            renderEcosystemMap();
        }
        
        function deleteActor(actorId) {
            projectData.ecosystemActors = projectData.ecosystemActors.filter(a => a.id !== actorId);
            projectData.ecosystemConnections = projectData.ecosystemConnections.filter(c => c.from !== actorId && c.to !== actorId);
            selectedActorId = null;
            renderEcosystemActorList();
            renderEcosystemMap();
        }

        // --- MODULE: CFIR Diagnostic ---
        function renderCfirDiagnostic() {
            container = document.getElementById('page-cfir-diagnostic');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Assess the Context (CFIR)</h1>
                    <p class="text-text-light mb-6">Use the CFIR framework to rate whether different factors in the setting will be barriers or facilitators to the project.</p>
                    <div id="cfir-accordion" class="space-y-4"></div>
                     <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('cfir-diagnostic')">Save and Mark as Complete</button>
                    </div>
                </div>`;
            renderCfirAccordion();
        }

        function renderCfirAccordion() {
            const container = document.getElementById('cfir-accordion');
            const cfirDomains = [
                { name: "The Innovation Itself", constructs: ["Relative Advantage", "Adaptability", "Complexity", "Evidence Strength & Quality"] },
                { name: "The Outer Setting (System)", constructs: ["Patient Needs & Resources", "External Policies & Incentives"] },
                { name: "The Inner Setting (Organization)", constructs: ["Structural Characteristics", "Networks & Communications", "Culture", "Implementation Climate", "Readiness for Implementation"] },
                { name: "The Individuals Involved", constructs: ["Knowledge & Beliefs", "Self-Efficacy", "Individual Stage of Change"] },
                { name: "The Implementation Process", constructs: ["Planning", "Engaging", "Executing", "Reflecting & Evaluating"] }
            ];

            container.innerHTML = cfirDomains.map(domain => `
                <details class="bg-bg-light border rounded-lg"><summary class="p-4 font-semibold text-lg flex justify-between items-center">${domain.name}<svg class="details-caret h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></summary>
                    <div class="p-4 border-t space-y-6">
                        <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-md"><label class="font-semibold block mb-1">Equity Considerations for ${domain.name}</label><textarea rows="2" class="w-full" placeholder="How might factors in this domain disproportionately affect marginalized groups?"></textarea></div>
                        ${domain.constructs.map(construct => renderCfirConstruct(construct)).join('')}
                    </div></details>`).join('');
            addInfoTipListeners();
        }
        
        function renderCfirConstruct(construct) {
            const constructId = construct.replace(/\s/g, '');
            const ratingData = projectData.cfirAssessment.ratings[constructId] || { valence: 0, notes: "" };
            return `
                <div class="border-t pt-4"><h4 class="font-semibold text-md mb-2">${construct} ${createInfoTip('Rate this from -2 (strong barrier) to +2 (strong facilitator).')}</h4>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div><label class="block text-sm font-medium mb-1">Rating</label>
                            <div class="cfir-rating-group bg-gray-200 rounded-md p-1">
                                ${[-2, -1, 0, 1, 2].map(val => `<label><input type="radio" name="rating-${constructId}" value="${val}" ${ratingData.valence == val ? 'checked' : ''} onchange="updateCfirRating('${constructId}', 'valence', this.value)"><span class="px-3 py-1 rounded-md">${val > 0 ? '+' : ''}${val}</span></label>`).join('')}
                            </div>
                            <div class="flex justify-between text-xs mt-1 px-1"><span>Barrier</span><span>Neutral</span><span>Facilitator</span></div>
                        </div>
                        <div><label class="block text-sm font-medium mb-1">Notes</label><textarea rows="3" placeholder="Why was this rating given? What is the evidence?" onchange="updateCfirRating('${constructId}', 'notes', this.value)">${ratingData.notes}</textarea></div>
                    </div></div>`;
        }

        function updateCfirRating(constructId, field, value) {
            if (!projectData.cfirAssessment.ratings[constructId]) {
                projectData.cfirAssessment.ratings[constructId] = {};
            }
            projectData.cfirAssessment.ratings[constructId][field] = field === 'valence' ? parseInt(value) : value;
        }
        
        // --- MODULE: Barrier Prioritizer ---
        function renderBarrierPrioritizer() {
            const container = document.getElementById('page-barrier-prioritizer');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Prioritize Barriers</h1>
                    <p class="text-text-light mb-6">Systematically identify and prioritize implementation barriers to focus efforts.</p>
                    <div class="grid lg:grid-cols-5 gap-8">
                        <div class="lg:col-span-2">
                            <h3 class="text-xl font-bold section-title mb-4">1. List & Rate Barriers</h3>
                            <div class="mb-4">
                               <button id="add-barrier-btn" class="w-full btn btn-secondary">Add Barrier</button>
                            </div>
                            <div id="barrier-list" class="space-y-2 h-96 overflow-y-auto p-2 bg-bg-light rounded border"></div>
                        </div>
                        <div class="lg:col-span-3">
                            <h3 class="text-xl font-bold section-title mb-4">2. Prioritization Matrix</h3>
                            <div id="barrier-plot-container" class="w-full h-[500px] relative bg-white border rounded">
                                <svg id="barrier-plot-svg" class="w-full h-full"></svg>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('barrier-prioritizer')">Save and Mark as Complete</button>
                    </div>
                </div>`;
            
            document.getElementById("add-barrier-btn").addEventListener("click", () => { openBarrierModal(null); });
            renderBarrierList();
            requestAnimationFrame(renderBarrierPlot);
        }

        function renderBarrierList() {
            const list = document.getElementById("barrier-list");
            if (!list) return;
            list.innerHTML = projectData.barriers.map(b => `
                <a href="#" class="block p-3 border-b border-border-color bg-white cursor-pointer hover:bg-yellow-50" onclick="event.preventDefault(); openBarrierModal(${b.id})">
                    ${b.text}
                </a>`).join('') || '<p class="text-center text-text-light p-4">No barriers added yet.</p>';
        }

        function renderBarrierPlot() {
            const container = d3.select("#barrier-plot-container");
            if (container.empty()) return;
            
            const bounds = container.node().getBoundingClientRect();
            if (bounds.width === 0) { requestAnimationFrame(renderBarrierPlot); return; } 

            const svg = container.select("svg");
            svg.selectAll("*").remove();

            const width = bounds.width;
            const height = bounds.height;
            const margin = {top: 40, right: 40, bottom: 60, left: 60};

            const x = d3.scaleLinear().domain([0, 100]).range([margin.left, width - margin.right]);
            const y = d3.scaleLinear().domain([0, 100]).range([height - margin.bottom, margin.top]);
            const frequencyScale = d3.scaleSqrt().domain([1, 100]).range([4, 30]);
            const equityColorPalette = ["#313695","#4575B4","#74ADD1","#ABD9E9","#E0F3F8","#FFFFBF","#FEE090","#FDAE61","#F46D43","#D73027","#A50026"];
            const equityColorScale = d3.scaleQuantile().domain([0, 100]).range(equityColorPalette.reverse());

            const quadrants = [
                { x: x(50), y: y(100), width: x(100) - x(50), height: y(50) - y(100), color: 'rgba(46, 125, 50, 0.05)', label: 'High Priority', textColor: '#1B5E20' },
                { x: x(0), y: y(100), width: x(50) - x(0), height: y(50) - y(100), color: 'rgba(251, 192, 45, 0.05)', label: 'Strategic Priority', textColor: '#F57F17' },
                { x: x(0), y: y(50), width: x(50) - x(0), height: y(0) - y(50), color: 'rgba(144, 164, 174, 0.05)', label: 'Low Priority', textColor: '#37474F' },
                { x: x(50), y: y(50), width: x(100) - x(50), height: y(0) - y(50), color: 'rgba(211, 47, 47, 0.05)', label: 'Target for Innovation', textColor: '#B71C1C' }
            ];
            svg.selectAll('.quadrant-bg').data(quadrants).enter().append('rect').attr('class', 'quadrant-bg').attr('x', d => d.x).attr('y', d => d.y).attr('width', d => d.width).attr('height', d => d.height).attr('fill', d => d.color);
            svg.selectAll('.quadrant-label').data(quadrants).enter().append('text').attr('class', 'quadrant-label').attr('x', d => d.x + 10).attr('y', d => d.y + 20).text(d => d.label).attr('fill', d=> d.textColor).style('font-weight', '600');

            const xAxis = d3.axisBottom(x).ticks(5);
            const yAxis = d3.axisLeft(y).ticks(5);
            svg.append("g").attr("transform", `translate(0, ${height - margin.bottom})`).call(xAxis);
            svg.append("g").attr("transform", `translate(${margin.left}, 0)`).call(yAxis);
            svg.append("text").attr("text-anchor", "middle").attr("x", width / 2).attr("y", height - 5).text("Importance");
            svg.append("text").attr("text-anchor", "middle").attr("transform", "rotate(-90)").attr("y", 15).attr("x", -height/2).text("Addressability");

            const ratedBarriers = projectData.barriers.filter(b => b.importance !== null && b.addressability !== null);
            
            const drag = d3.drag()
                .on("start", function(event) { d3.select(this).raise().style('cursor', 'grabbing'); })
                .on("drag", function(event, d) {
                    d.importance = Math.max(0, Math.min(100, x.invert(event.x)));
                    d.addressability = Math.max(0, Math.min(100, y.invert(event.y)));
                    d3.select(this).attr("transform", `translate(${x(d.importance)}, ${y(d.addressability)})`);
                })
                .on("end", function(event, d) {
                    d3.select(this).style('cursor', 'grab');
                    renderBarrierList();
                });

            const nodes = svg.selectAll(".barrier-node").data(ratedBarriers, d => d.id).enter().append("g")
                .attr("class", "barrier-node").attr("transform", d => `translate(${x(d.importance)}, ${y(d.addressability)})`)
                .style('cursor', 'grab').call(drag);
            
            nodes.append("circle").attr("r", d => frequencyScale(d.frequency)).attr("fill", d => equityColorScale(d.equityImpact)).attr("stroke", d => d3.color(equityColorScale(d.equityImpact)).darker(0.7)).attr("stroke-width", 1.5).attr("fill-opacity", 0.7);
            nodes.on("mouseover", (event, d) => {
                barrierTooltip.transition().duration(200).style("opacity", .9);
                barrierTooltip.html(`<strong>${d.text}</strong><br/>Equity Impact: ${d.equityImpact}<br/>Frequency: ${d.frequency}`)
                    .style("left", (event.pageX + 15) + "px").style("top", (event.pageY - 28) + "px");
            }).on("mouseout", () => {
                barrierTooltip.transition().duration(500).style("opacity", 0);
            }).on("click", (event, d) => {
                if (!event.defaultPrevented) { openBarrierModal(d.id); }
            });
        }

        function openBarrierModal(barrierId) {
            const isNew = barrierId === null;
            const barrier = isNew 
                ? { id: null, text: "", importance: 50, addressability: 50, frequency: 50, equityImpact: 50, level: 'Inner Setting', notesImportance: "", notesAddressability: "", notesFrequency: "", notesEquityImpact: "" }
                : projectData.barriers.find(b => b.id === barrierId);
            
            if (!barrier) return;
            
            const createSliderRow = (criterion, label, value, notes, tip) => `<div class="p-3 bg-bg-light rounded-md"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block font-semibold">${label} ${createInfoTip(tip)} <span class="font-normal text-gray-500" id="${criterion}-value">${value}</span></label><input type="range" min="1" max="100" value="${value}" name="${criterion}" class="w-full mt-1 accent-red-cardinal" oninput="document.getElementById('${criterion}-value').textContent = this.value"></div><div><label class="block font-semibold text-sm mb-1">Notes for ${label}</label><textarea name="notes${criterion.charAt(0).toUpperCase() + criterion.slice(1)}" rows="2" class="w-full border rounded-md text-sm">${notes || ''}</textarea></div></div></div>`;
            const cfirLevels = ["Intervention Characteristics", "Outer Setting", "Inner Setting", "Characteristics of Individuals", "Process"];

            const modalHTML = `
            <div id="barrier-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-[100]">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-full overflow-y-auto">
                     <div class="p-6 border-b"><h2 class="text-2xl font-bold page-title">${isNew ? 'Add New' : 'Edit'} Barrier</h2></div>
                     <div class="p-6 space-y-4">
                         <input type="hidden" id="current-barrier-id" value="${barrierId || ''}">
                         <div><label class="block font-semibold">Barrier</label><textarea id="barrier-text-input" rows="2" class="w-full border rounded-md" placeholder="Describe the barrier...">${barrier.text}</textarea></div>
                         <div><label class="block font-semibold">Determinant Level ${createInfoTip("Categorize this barrier using CFIR domains. This will group it in the Logic Model.")}</label>
                             <select id="barrier-level-select" class="w-full mt-1">
                                 ${cfirLevels.map(level => `<option value="${level}" ${barrier.level === level ? 'selected' : ''}>${level}</option>`).join('')}
                             </select>
                         </div>
                         ${createSliderRow('importance', 'Importance', barrier.importance, barrier.notesImportance, 'How critical is it to address this barrier for project success?')}
                         ${createSliderRow('addressability', 'Addressability', barrier.addressability, barrier.notesAddressability, 'How feasible is it to address this barrier with available resources and influence?')}
                         ${createSliderRow('frequency', 'Frequency', barrier.frequency, barrier.notesFrequency, 'How often does this barrier occur? (This affects the size of the dot on the matrix)')}
                         ${createSliderRow('equityImpact', 'Equity Impact', barrier.equityImpact, barrier.notesEquityImpact, 'How much does this barrier disproportionately affect marginalized groups? (This affects the color of the dot on the matrix)')}
                     </div>
                     <div class="p-4 bg-gray-50 border-t flex justify-end space-x-2">
                         <button type="button" class="btn bg-gray-200 text-gray-700" onclick="closeModal('barrier-modal')">Cancel</button>
                         <button type="button" class="btn btn-primary" onclick="saveBarrierDetails()">Save Details</button>
                     </div>
                </div>
            </div>`;
            document.getElementById('modal-container').innerHTML = modalHTML;
            addInfoTipListeners();
        }

        function saveBarrierDetails() {
            const barrierId = document.getElementById('current-barrier-id').value;
            const isNew = barrierId === '';
            let barrier = isNew ? { id: Date.now() } : projectData.barriers.find(b => b.id == barrierId);
            if (!barrier) return;
            barrier.text = document.getElementById('barrier-text-input').value;
            if (!barrier.text.trim()) { alert("Please enter a description for the barrier."); return; }
            barrier.level = document.getElementById('barrier-level-select').value;
            const criteria = ['importance', 'addressability', 'frequency', 'equityImpact'];
            criteria.forEach(c => {
                const slider = document.querySelector(`input[name="${c}"]`);
                barrier[c] = slider ? parseInt(slider.value) : 50;
                const noteKey = `notes${c.charAt(0).toUpperCase() + c.slice(1)}`;
                const noteInput = document.querySelector(`textarea[name="${noteKey}"]`);
                if (noteInput) { barrier[noteKey] = noteInput.value; }
            });
            if (isNew) projectData.barriers.push(barrier);
            closeModal('barrier-modal');
            renderBarrierList();
            renderBarrierPlot();
        }

        // --- MODULE: Readiness Assessor ---
        function renderReadinessAssessor() {
            const container = document.getElementById('page-readiness-assessor');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Assess Readiness for Change</h1>
                    <p class="text-text-light mb-6">Based on Weiner's theory, assess how ready the organization is for this specific change.</p>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-xl font-semibold section-title mb-2">Change Commitment (Shared Resolve)</h3>
                            <p class="text-sm text-text-light mb-3">To what extent do people feel a shared determination to implement the change?</p>
                            <input type="range" min="0" max="100" value="${projectData.readinessAssessment.commitment}" oninput="this.nextElementSibling.textContent = this.value + '%'; projectData.readinessAssessment.commitment = this.value; updateReadinessStrategies();">
                            <span class="font-bold ml-2">${projectData.readinessAssessment.commitment}%</span>
                            <textarea class="mt-2" rows="2" placeholder="Notes on commitment..." onchange="projectData.readinessAssessment.commitmentNotes = this.value">${projectData.readinessAssessment.commitmentNotes}</textarea>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold section-title mb-2">Change Efficacy (Shared Confidence)</h3>
                            <p class="text-sm text-text-light mb-3">To what extent do people share a belief in their collective ability to implement the change?</p>
                            <input type="range" min="0" max="100" value="${projectData.readinessAssessment.efficacy}" oninput="this.nextElementSibling.textContent = this.value + '%'; projectData.readinessAssessment.efficacy = this.value; updateReadinessStrategies();">
                            <span class="font-bold ml-2">${projectData.readinessAssessment.efficacy}%</span>
                            <textarea class="mt-2" rows="2" placeholder="Notes on efficacy..." onchange="projectData.readinessAssessment.efficacyNotes = this.value">${projectData.readinessAssessment.efficacyNotes}</textarea>
                        </div>
                    </div>
                    <div id="readiness-strategies" class="mt-8"></div>
                    <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('readiness-assessor')">Save and Mark as Complete</button>
                    </div>
                </div>`;
            updateReadinessStrategies();
        }

        function updateReadinessStrategies() {
            const commitment = parseInt(projectData.readinessAssessment.commitment);
            const efficacy = parseInt(projectData.readinessAssessment.efficacy);
            const container = document.getElementById('readiness-strategies');
            if (!container) return;
            let strategies = [];

            if (commitment < 50) strategies.push("<strong>Build Commitment:</strong> Present a compelling case for the change, highlighting the gap between current and desired performance. Use early adopters and champions to build momentum.");
            if (efficacy < 50) strategies.push("<strong>Build Efficacy:</strong> Provide robust training and coaching. Break down the implementation into smaller, manageable steps to create early wins. Ensure resources and support are readily available.");
            if (strategies.length === 0) strategies.push("<strong>Maintain Momentum:</strong> Readiness appears strong. Focus on reinforcing commitment and efficacy through regular communication, feedback, and celebrating successes.");

            container.innerHTML = `<h3 class="text-xl font-bold section-title mb-3">Suggested Strategies</h3><div class="bg-green-50 border border-green-200 p-4 rounded-lg space-y-3">${strategies.map(s => `<p class="text-green-800">${s}</p>`).join('')}</div>`;
        }
        
        // --- MODULE: Explore ERIC Strategies (NEW) ---
        function renderExploreEricStrategies() {
            const container = document.getElementById('page-explore-eric-strategies');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Explore ERIC Strategies</h1>
                    <p class="text-text-light mb-6">Select implementation strategies from the ERIC compilation to address your prioritized determinants and populate your logic model.</p>
                    
                    <div class="grid lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">
                            <h2 class="text-xl font-bold section-title mb-4">Prioritized Determinants</h2>
                            <div id="eric-determinants-list" class="determinant-list bg-bg-light p-3 rounded-lg border"></div>
                        </div>
                        <div class="lg:col-span-2">
                            <h2 class="text-xl font-bold section-title mb-4">ERIC Strategy Library</h2>
                            <input type="text" id="eric-strategy-search" placeholder="Search strategies..." class="mb-4" onkeyup="filterEricStrategySelector()">
                            <div id="eric-strategy-selector" class="strategy-list pr-2"></div>
                        </div>
                    </div>

                    <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('explore-eric-strategies')">Save and Mark as Complete</button>
                    </div>
                </div>
            `;
            renderEricDeterminantsList();
            renderEricStrategySelector();
        }

        function renderEricDeterminantsList() {
            const container = document.getElementById('eric-determinants-list');
            if (!container) return;

            let facilitatorsHTML = '<div><h3 class="font-semibold text-green-700 mb-2">Facilitators</h3><ul class="list-disc pl-5 space-y-1">';
            let barriersHTML = '<div class="mt-4"><h3 class="font-semibold text-red-700 mb-2">Barriers</h3><ul class="list-disc pl-5 space-y-1">';
            let hasFacilitators = false;
            let hasBarriers = false;

            // From CFIR
            Object.entries(projectData.cfirAssessment.ratings).forEach(([key, rating]) => {
                if (rating.valence > 0) {
                    hasFacilitators = true;
                    const constructName = key.replace(/([A-Z])/g, ' $1').trim();
                    facilitatorsHTML += `<li class="text-sm text-gray-700">${constructName}</li>`;
                } else if (rating.valence < 0) {
                    hasBarriers = true;
                    const constructName = key.replace(/([A-Z])/g, ' $1').trim();
                    barriersHTML += `<li class="text-sm text-gray-700">${constructName}</li>`;
                }
            });

            // From Barrier Prioritizer
            projectData.barriers.forEach(barrier => {
                hasBarriers = true;
                barriersHTML += `<li class="text-sm text-gray-700">${barrier.text}</li>`;
            });

            if (!hasFacilitators) facilitatorsHTML += '<p class="text-sm text-gray-500">No facilitators identified.</p>';
            if (!hasBarriers) barriersHTML += '<p class="text-sm text-gray-500">No barriers identified.</p>';

            facilitatorsHTML += '</ul></div>';
            barriersHTML += '</ul></div>';

            container.innerHTML = facilitatorsHTML + barriersHTML;
        }

        function filterEricStrategySelector() {
            const searchTerm = document.getElementById('eric-strategy-search').value.toLowerCase();
            const allStrategies = document.querySelectorAll('#eric-strategy-selector .strategy-item-wrapper');
            const allClusters = document.querySelectorAll('#eric-strategy-selector details');

            allStrategies.forEach(item => {
                const name = item.dataset.name.toLowerCase();
                const definition = item.dataset.definition.toLowerCase();
                if (name.includes(searchTerm) || definition.includes(searchTerm)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });

            // Open/close clusters based on visible children
            allClusters.forEach(cluster => {
                const visibleChildren = cluster.querySelectorAll('.strategy-item-wrapper:not([style*="display: none"])');
                if (searchTerm && visibleChildren.length > 0) {
                    cluster.open = true;
                } else if (searchTerm) {
                    cluster.open = false;
                }
                if (visibleChildren.length === 0) {
                    cluster.style.display = 'none';
                } else {
                    cluster.style.display = '';
                }
            });
        }

        const ERIC_STRATEGIES = [
            { cluster: "Use Evaluative and Iterative Strategies", name: "Assess for readiness and identify barriers and facilitators", definition: "Assess various aspects of an organization to determine its degree of readiness to implement, barriers that may impede implementation, and strengths that can be used in the implementation effort" },
            { cluster: "Use Evaluative and Iterative Strategies", name: "Audit and provide feedback", definition: "Collect and summarize clinical performance data over a specified time period and give it to clinicians and administrators to monitor, evaluate, and modify provider behavior" },
            { cluster: "Use Evaluative and Iterative Strategies", name: "Capture and share local knowledge", definition: "Capture local knowledge from implementation sites on how implementers and clinicians made something work in their setting and then share it with other sites" },
            { cluster: "Use Evaluative and Iterative Strategies", name: "Conduct cyclical small tests of change", definition: "Implement changes in a cyclical fashion using small tests of change before taking changes system-wide. Tests of change benefit from systematic measurement, and results of the tests of change are studied for insights on how to do better. This process continues serially over time, and refinement is added with each cycle" },
            { cluster: "Use Evaluative and Iterative Strategies", name: "Conduct local consensus discussions", definition: "Include local providers and other stakeholders in discussions that address whether the chosen problem is important and whether the clinical innovation to address it is appropriate" },
            { cluster: "Use Evaluative and Iterative Strategies", name: "Conduct local needs assessment", definition: "Collect and analyze data related to the need for the innovation" },
            { cluster: "Use Evaluative and Iterative Strategies", name: "Obtain and use patient/consumer and family feedback", definition: "Develop strategies to increase patient/consumer and family feedback on the implementation effort" },
            { cluster: "Use Evaluative and Iterative Strategies", name: "Organize clinician implementation team meetings", definition: "Develop and support teams of clinicians who are implementing the innovation and give them protected time to reflect on the implementation effort, share lessons learned, and support one another's learning" },
            { cluster: "Use Evaluative and Iterative Strategies", name: "Purposefully reexamine the implementation", definition: "Monitor progress and adjust clinical practices and implementation strategies to continuously improve the quality of care" },
            { cluster: "Use Evaluative and Iterative Strategies", name: "Use data warehousing techniques", definition: "Integrate clinical records across facilities and organizations to facilitate implementation across systems" },
            { cluster: "Use Evaluative and Iterative Strategies", name: "Use an implementation advisor", definition: "Seek guidance from experts in implementation" },
            { cluster: "Use Evaluative and Iterative Strategies", name: "Use data experts", definition: "Involve, hire, and/or consult experts to inform management on the use of data generated by implementation efforts" },
            { cluster: "Provide Interactive Assistance", name: "Centralize technical assistance", definition: "Develop and use a centralized system to deliver technical assistance focused on implementation issues" },
            { cluster: "Provide Interactive Assistance", name: "Facilitation", definition: "A process of interactive problem solving and support that occurs in a context of a recognized need for improvement and a supportive interpersonal relationship" },
            { cluster: "Provide Interactive Assistance", name: "Provide clinical supervision", definition: "Provide clinicians with ongoing supervision focusing on the innovation. Provide training for clinical supervisors who will supervise clinicians who provide the innovation" },
            { cluster: "Provide Interactive Assistance", name: "Provide local technical assistance", definition: "Develop and use a system to deliver technical assistance focused on implementation issues using local personnel" },
            { cluster: "Provide Interactive Assistance", name: "Provide ongoing consultation", definition: "Provide ongoing consultation with one or more experts in the strategies used to support implementing the innovation" },
            { cluster: "Adapt and Tailor to Context", name: "Promote adaptability", definition: "Identify the ways a clinical innovation can be tailored to meet local needs and clarify which elements of the innovation must be maintained to preserve fidelity" },
            { cluster: "Adapt and Tailor to Context", name: "Tailor strategies", definition: "Tailor the implementation strategies to address barriers and leverage facilitators that were identified through earlier data collection" },
            { cluster: "Develop Stakeholder Interrelationships", name: "Build a coalition", definition: "Recruit and cultivate relationships with partners in the implementation effort" },
            { cluster: "Develop Stakeholder Interrelationships", name: "Develop academic partnerships", definition: "Partner with a university or academic unit for the purposes of shared training and bringing research skills to an implementation project" },
            { cluster: "Develop Stakeholder Interrelationships", name: "Identify and prepare champions", definition: "Identify and prepare individuals who dedicate themselves to supporting, marketing and driving through an implementation, overcoming indifference or resistance that the intervention may provoke in an organization" },
            { cluster: "Develop Stakeholder Interrelationships", name: "Identify early adopters", definition: "Identify early adopters at the local site to learn from their experiences with the practice innovation" },
            { cluster: "Develop Stakeholder Interrelationships", name: "Inform local opinion leaders", definition: "Inform providers identified by colleagues as opinion leaders or 'educationally influential' about the clinical innovation in the hopes that they will influence colleagues to adopt it" },
            { cluster: "Develop Stakeholder Interrelationships", name: "Involve executive boards", definition: "Involve existing governing structures (e.g., boards of directors, medical staff boards of governance) in the implementation effort, including the review of data on implementation processes" },
            { cluster: "Develop Stakeholder Interrelationships", name: "Involve patients/consumers and family members", definition: "Engage or include patients/consumers and families in the implementation effort" },
            { cluster: "Develop Stakeholder Interrelationships", name: "Promote network weaving", definition: "Identify and build on existing high-quality working relationships and networks within and outside the organization, organizational units, teams, etc. to promote information sharing, collaborative problem-solving, and a shared vision/goal related to implementing the innovation" },
            { cluster: "Develop Stakeholder Interrelationships", name: "Use advisory boards and workgroups", definition: "Create and engage a formal group of multiple kinds of stakeholders to provide input and advice on implementation efforts and to elicit recommendations for improvements" },
            { cluster: "Train and Educate Stakeholders", name: "Conduct educational meetings", definition: "Hold meetings targeted toward different stakeholder groups (e.g., providers, administrators, other organizational stakeholders, and community, patient/consumer, and family stakeholders) to teach them about the clinical innovation" },
            { cluster: "Train and Educate Stakeholders", name: "Conduct educational outreach visits", definition: "Have a trained person meet with providers in their practice settings to educate providers about the clinical innovation with the intent of changing the provider's practice" },
            { cluster: "Train and Educate Stakeholders", name: "Conduct ongoing training", definition: "Plan for and conduct training in the clinical innovation in an ongoing way" },
            { cluster: "Train and Educate Stakeholders", name: "Create a learning collaborative", definition: "Facilitate the formation of groups of providers or provider organizations and foster a collaborative learning environment to improve implementation of the clinical innovation" },
            { cluster: "Train and Educate Stakeholders", name: "Develop educational materials", definition: "Develop and format manuals, toolkits, and other supporting materials in ways that make it easier for stakeholders to learn about the innovation and for clinicians to learn how to deliver the clinical innovation" },
            { cluster: "Train and Educate Stakeholders", name: "Distribute educational materials", definition: "Distribute educational materials (including guidelines, manuals, and toolkits) in person, by mail, and/or electronically" },
            { cluster: "Train and Educate Stakeholders", name: "Make training dynamic", definition: "Vary the information delivery methods to cater to different learning styles and work contexts, and shape the training in the innovation to be interactive" },
            { cluster: "Train and Educate Stakeholders", name: "Shadow other experts", definition: "Provide ways for key individuals to directly observe experienced people engage with or use the targeted practice change/innovation" },
            { cluster: "Train and Educate Stakeholders", name: "Use train-the-trainer strategies", definition: "Train designated clinicians or organizations to train others in the clinical innovation" },
            { cluster: "Train and Educate Stakeholders", name: "Visit other sites", definition: "Visit sites where a similar implementation effort has been considered successful" },
            { cluster: "Train and Educate Stakeholders", name: "Work with educational institutions", definition: "Encourage educational institutions to train clinicians in the innovation" },
            { cluster: "Support Clinicians", name: "Change physical structure and equipment", definition: "Evaluate current configurations and adapt, as needed, the physical structure and/or equipment (e.g., changing the layout of a room, adding equipment) to best accommodate the targeted innovation" },
            { cluster: "Support Clinicians", name: "Create new clinical teams", definition: "Change who serves on the clinical team, adding different disciplines and different skills to make it more likely that the clinical innovation is delivered (or is more successfully delivered)" },
            { cluster: "Support Clinicians", name: "Develop an implementation glossary", definition: "Develop and distribute a list of terms describing the innovation, implementation, and stakeholders in the organizational change" },
            { cluster: "Support Clinicians", name: "Develop and implement tools for quality monitoring", definition: "Develop, test, and introduce into quality-monitoring systems the right input-the appropriate language, protocols, algorithms, standards, and measures (of processes patient/consumer outcomes, and implementation outcomes) that are often specific to the innovation being implemented" },
            { cluster: "Support Clinicians", name: "Develop and organize quality monitoring systems", definition: "Develop and organize systems and procedures that monitor clinical processes and/or outcomes for the purpose of quality assurance and improvement" },
            { cluster: "Support Clinicians", name: "Facilitate relay of clinical data to providers", definition: "Provide as close to real-time data as possible about key measures of process/outcomes using integrated modes/channels of communication in a way that promotes use of the targeted innovation" },
            { cluster: "Support Clinicians", name: "Model and simulate change", definition: "Model or simulate the change that will be implemented prior to implementation" },
            { cluster: "Support Clinicians", name: "Remind clinicians", definition: "Develop reminder systems designed to help clinicians to recall information and/or prompt them to use the clinical innovation" },
            { cluster: "Support Clinicians", name: "Revise professional roles", definition: "Shift and revise roles among professionals who provide care, and redesign job characteristics" },
            { cluster: "Engage Consumers", name: "Intervene with patients/consumers to enhance uptake and adherence", definition: "Develop strategies with patients to encourage and problem solve around adherence" },
            { cluster: "Engage Consumers", name: "Prepare patients/consumers to be active participants", definition: "Prepare patients/consumers to be active in their care, to ask questions, and specifically to inquire about care guidelines, the evidence behind clinical decisions, or about available evidence-supported treatments" },
            { cluster: "Use Financial Strategies", name: "Access new funding", definition: "Access new or existing money to facilitate the implementation" },
            { cluster: "Use Financial Strategies", name: "Alter incentive/allowance structures", definition: "Work to incentivize the adoption and implementation of the clinical innovation" },
            { cluster: "Use Financial Strategies", name: "Alter patient/consumer fees", definition: "Create fee structures where patients/consumers pay less for preferred treatments (the clinical innovation) and more for less-preferred treatments" },
            { cluster: "Use Financial Strategies", name: "Develop disincentives", definition: "Provide financial disincentives for failure to implement or use the clinical innovations" },
            { cluster: "Use Financial Strategies", name: "Fund and contract for the clinical innovation", definition: "Governments and other payers of services issue requests for proposals to deliver the innovation, use contracting processes to motivate providers to deliver the clinical innovation, and develop new funding formulas that make it more likely that providers will deliver the innovation" },
            { cluster: "Use Financial Strategies", name: "Increase demand", definition: "Attempt to influence the market for the clinical innovation to increase competition intensity and to increase the maturity of the market for the clinical innovation" },
            { cluster: "Use Financial Strategies", name: "Make billing easier", definition: "Make it easier to bill for the clinical innovation" },
            { cluster: "Use Financial Strategies", name: "Place innovation on fee for service lists/formularies", definition: "Work to place the clinical innovation on lists of actions for which providers can be reimbursed (e.g., a drug is placed on a formulary, a procedure is now reimbursable)" },
            { cluster: "Use Financial Strategies", name: "Use capitated payments", definition: "Pay providers or care systems a set amount per patient/consumer for delivering clinical care" },
            { cluster: "Use Financial Strategies", name: "Use other payment schemes", definition: "Introduce payment approaches (in a catch-all category)" },
            { cluster: "Change Infrastructure", name: "Change accreditation or membership requirements", definition: "Strive to alter accreditation standards so that they require or encourage use of the clinical innovation. Work to alter membership organization requirements so that those who want to affiliate with the organization are encouraged or required to use the clinical innovation" },
            { cluster: "Change Infrastructure", name: "Change liability laws", definition: "Participate in liability reform efforts that make clinicians more willing to deliver the clinical innovation" },
            { cluster: "Change Infrastructure", name: "Change record systems", definition: "Change records systems to allow better assessment of implementation or clinical outcomes" },
            { cluster: "Change Infrastructure", name: "Change service sites", definition: "Change the location of clinical service sites to increase access" },
            { cluster: "Change Infrastructure", name: "Create or change credentialing and/or licensure standards", definition: "Create an organization that certifies clinicians in the innovation or encourage an existing organization to do so. Change governmental professional certification or licensure requirements to include delivering the innovation. Work to alter continuing education requirements to shape professional practice toward the innovation" },
            { cluster: "Change Infrastructure", name: "Develop a formal implementation blueprint", definition: "Develop a formal implementation blueprint that includes all goals and strategies. The blueprint should include the following: 1) aim/purpose of the implementation; 2) scope of the change (e.g., what organizational units are affected); 3) timeframe and milestones; and 4) appropriate performance/progress measures. Use and update this plan to guide the implementation effort over time" },
            { cluster: "Change Infrastructure", name: "Develop resource sharing agreements", definition: "Develop partnerships with organizations that have resources needed to implement the innovation" },
            { cluster: "Change Infrastructure", name: "Mandate change", definition: "Have leadership declare the priority of the innovation and their determination to have it implemented" },
            { cluster: "Change Infrastructure", name: "Obtain formal commitments", definition: "Obtain written commitments from key partners that state what they will do to implement the innovation" },
            { cluster: "Change Infrastructure", name: "Start a dissemination organization", definition: "Identify or start a separate organization that is responsible for disseminating the clinical innovation. It could be a for-profit or non-profit organization" },
            { cluster: "Use Mass Media", name: "Use mass media", definition: "Use media to reach large numbers of people to spread the word about the clinical innovation" }
        ];

        function renderEricStrategySelector() {
            const container = document.getElementById('eric-strategy-selector');
            if (!container) return;
            
            const groupedStrategies = ERIC_STRATEGIES.reduce((acc, strategy) => {
                (acc[strategy.cluster] = acc[strategy.cluster] || []).push(strategy);
                return acc;
            }, {});

            container.innerHTML = Object.entries(groupedStrategies).map(([cluster, strategies]) => {
                return `
                    <details class="bg-white border rounded-lg mb-2">
                        <summary class="p-3 font-semibold flex justify-between items-center text-primary-color">${cluster} <svg class="details-caret h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></summary>
                        <div class="p-3 border-t">
                            ${strategies.map(strategy => {
                                const isSelected = projectData.irlm.strategies.some(s => s.text === strategy.name);
                                return `
                                <div class="strategy-item-wrapper py-2 border-b last:border-b-0" data-name="${strategy.name}" data-definition="${strategy.definition}">
                                    <label class="flex items-start space-x-3">
                                        <input type="checkbox" class="mt-1" ${isSelected ? 'checked' : ''} onchange="toggleIrlmStrategy(this, '${strategy.name}')">
                                        <span class="flex-1">
                                            <span class="font-medium">${strategy.name}</span>
                                            ${createInfoTip(strategy.definition)}
                                        </span>
                                    </label>
                                </div>
                                `
                            }).join('')}
                        </div>
                    </details>
                `;
            }).join('');
            addInfoTipListeners();
        }

        function toggleIrlmStrategy(checkbox, strategyName) {
            if (checkbox.checked) {
                // Add if not already present
                if (!projectData.irlm.strategies.some(s => s.text === strategyName)) {
                    projectData.irlm.strategies.push({ id: Date.now(), text: strategyName });
                }
            } else {
                // Remove
                projectData.irlm.strategies = projectData.irlm.strategies.filter(s => s.text !== strategyName);
            }
        }

        // --- MODULE: IRLM ---
        function renderIRLM() {
            const container = document.getElementById('page-irlm');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Implementation Research Logic Model</h1>
                    <p class="text-text-light mb-6">This logic model visually connects determinants, strategies, mechanisms, and outcomes based on inputs from other modules.</p>
                    
                    <div class="flex justify-end mb-4">
                        <button class="btn btn-secondary" onclick="showPage('page-explore-eric-strategies')">Edit Strategies</button>
                    </div>

                    <h2 class="text-2xl font-bold section-title mt-6 mb-4">Logic Model Figure</h2>
                    <div id="irlm-figure" class="w-full border rounded-lg p-4 bg-white overflow-x-auto">
                        <!-- D3 will render the figure here -->
                    </div>

                    <div class="grid md:grid-cols-2 gap-8 mt-8">
                        <div>
                            <h2 class="text-2xl font-bold section-title mb-4">Mechanisms</h2>
                            <div id="irlm-mechanisms-list" class="space-y-2 mb-3"></div>
                             <div class="flex">
                                <input type="text" id="irlm-mechanism-input" placeholder="Add a new mechanism..." class="rounded-r-none">
                                <button class="btn btn-secondary rounded-l-none text-sm" onclick="addIrlmItem('mechanisms')">Add</button>
                            </div>
                        </div>
                        <div>
                            <!-- Placeholder for future content or can be removed -->
                        </div>
                    </div>

                    <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('irlm')">Save and Mark as Complete</button>
                    </div>
                </div>`;
            
            renderIrlmLists();
            drawIRLMFigure();
        }

        function drawIRLMFigure() {
            const container = d3.select("#irlm-figure");
            container.html(""); // Clear previous render

            // 1. Get and process data
            const determinants = {};
            const cfirLevelMap = {
                "The Innovation Itself": "Intervention Characteristics",
                "The Outer Setting (System)": "Outer Setting",
                "The Inner Setting (Organization)": "Inner Setting",
                "The Individuals Involved": "Characteristics of Individuals",
                "The Implementation Process": "Process"
            };
             const cfirDomains = [
                { name: "The Innovation Itself", constructs: ["Relative Advantage", "Adaptability", "Complexity", "Evidence Strength & Quality"] },
                { name: "The Outer Setting (System)", constructs: ["Patient Needs & Resources", "External Policies & Incentives"] },
                { name: "The Inner Setting (Organization)", constructs: ["Structural Characteristics", "Networks & Communications", "Culture", "Implementation Climate", "Readiness for Implementation"] },
                { name: "The Individuals Involved", constructs: ["Knowledge & Beliefs", "Self-Efficacy", "Individual Stage of Change"] },
                { name: "The Implementation Process", constructs: ["Planning", "Engaging", "Executing", "Reflecting & Evaluating"] }
            ];

            // Process rated CFIR constructs
            for (const domain of cfirDomains) {
                const level = cfirLevelMap[domain.name];
                if (!determinants[level]) determinants[level] = [];
                
                for (const construct of domain.constructs) {
                    const constructId = construct.replace(/\s/g, '');
                    const ratingData = projectData.cfirAssessment.ratings[constructId];
                    if (ratingData && ratingData.valence !== 0) {
                        determinants[level].push({
                            text: construct,
                            type: ratingData.valence < 0 ? 'barrier' : 'facilitator'
                        });
                    }
                }
            }

            // Process manually added barriers
            projectData.barriers.forEach(barrier => {
                if (!determinants[barrier.level]) determinants[barrier.level] = [];
                determinants[barrier.level].push({ text: barrier.text, type: 'barrier' });
            });


            const strategies = projectData.irlm.strategies;
            const mechanisms = projectData.irlm.mechanisms;
            const outcomes = projectData.outcomes.logicModel;
            
            // 2. Build HTML structure
            const figure = container.append('div').attr('class', 'irlm-figure-grid grid grid-cols-1 md:grid-cols-4 gap-4');

            // -- Determinants Column --
            const detCol = figure.append('div').attr('class', 'irlm-column');
            detCol.append('div').attr('class', 'irlm-column-title').text('Determinants');
            Object.keys(determinants).sort().forEach(level => {
                if (determinants[level].length > 0) {
                    const group = detCol.append('div').attr('class', 'irlm-subgroup');
                    group.append('div').attr('class', 'irlm-subgroup-title').text(level);
                    const list = group.append('div').attr('class', 'space-y-2');
                    determinants[level].forEach(item => {
                        list.append('div').attr('class', `irlm-item ${item.type}`).text(item.text);
                    });
                }
            });

            // -- Strategies Column --
            const stratCol = figure.append('div').attr('class', 'irlm-column');
            stratCol.append('div').attr('class', 'irlm-column-title').text('Strategies');
            strategies.forEach(item => {
                stratCol.append('div').attr('class', 'irlm-item').text(item.text);
            });

            // -- Mechanisms Column --
            const mechCol = figure.append('div').attr('class', 'irlm-column');
            mechCol.append('div').attr('class', 'irlm-column-title').text('Mechanisms');
            mechanisms.forEach(item => {
                mechCol.append('div').attr('class', 'irlm-item').text(item.text);
            });

            // -- Outcomes Column --
            const outCol = figure.append('div').attr('class', 'irlm-column');
            outCol.append('div').attr('class', 'irlm-column-title').text('Outcomes');
            
            const outSubCols = {
                implementation: { title: "Implementation", items: outcomes.implementation },
                service: { title: "Service", items: outcomes.service },
                client: { title: "Clinical/Patient", items: outcomes.client }
            };

            Object.values(outSubCols).forEach(subColData => {
                 if (subColData.items && subColData.items.length > 0) {
                    const group = outCol.append('div').attr('class', 'irlm-subgroup');
                    group.append('div').attr('class', 'irlm-subgroup-title').text(subColData.title);
                    const list = group.append('div').attr('class', 'space-y-2');
                    subColData.items.forEach(item => {
                        list.append('div').attr('class', 'irlm-item').text(item);
                    });
                 }
            });
        }
        
        function renderIrlmLists() {
            ['mechanisms'].forEach(type => { // Only rendering mechanisms now
                const list = document.getElementById(`irlm-${type}-list`);
                if (!list) return;
                list.innerHTML = projectData.irlm[type].map(item => `
                    <div class="bg-white p-2 rounded border flex justify-between items-center">
                        <span>${item.text}</span>
                        <button class="text-red-500 font-bold" onclick="deleteIrlmItem('${type}', ${item.id})">&times;</button>
                    </div>`).join('') || `<p class="text-sm text-center text-text-light">No ${type} added yet.</p>`;
            });
        }

        function addIrlmItem(type) {
            const input = document.getElementById(`irlm-${type === 'strategies' ? 'strategy' : 'mechanism'}-input`);
            if (input && input.value.trim()) {
                projectData.irlm[type].push({ id: Date.now(), text: input.value.trim() });
                input.value = '';
                renderIrlmLists();
                drawIRLMFigure();
            }
        }

        function deleteIrlmItem(type, id) {
            projectData.irlm[type] = projectData.irlm[type].filter(item => item.id !== id);
            renderIrlmLists();
            drawIRLMFigure();
        }


        // --- MODULE: Behavioral Diagnosis ---
        function renderBehavioralDiagnosis() {
            const container = document.getElementById('page-behavioral-diagnosis');
            const tdfDomains = ["Knowledge", "Skills", "Social/Professional Role and Identity", "Beliefs about Capabilities", "Optimism", "Beliefs about Consequences", "Reinforcement", "Intentions", "Goals", "Memory, Attention and Decision Processes", "Environmental Context and Resources", "Social Influences", "Emotion", "Behavioral Regulation"];
            
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Understand Behavior Change (COM-B)</h1>
                    <p class="text-text-light mb-6">For each key behavior required by the new practice, figure out what might get in the way.</p>
                    <div class="space-y-6">
                        <div>
                            <label class="block font-semibold">Target Behavior ${createInfoTip("The specific action people need to do. E.g., 'Primary care physicians conduct a depression screening at every annual visit.'")}</label>
                            <input type="text" id="target-behavior-input" placeholder="Describe the target behavior...">
                        </div>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div><h3 class="font-semibold text-lg section-title">Capability</h3><textarea id="capability-notes" rows="4" placeholder="Do they have the knowledge and skills?"></textarea></div>
                            <div><h3 class="font-semibold text-lg section-title">Opportunity</h3><textarea id="opportunity-notes" rows="4" placeholder="Is the environment supportive? Do they have time/resources?"></textarea></div>
                            <div><h3 class="font-semibold text-lg section-title">Motivation</h3><textarea id="motivation-notes" rows="4" placeholder="Do they believe it's important? Do they want to do it?"></textarea></div>
                        </div>
                        <div>
                            <label class="block font-semibold">Deeper Dive (TDF Domains) ${createInfoTip("Select all domains from the Theoretical Domains Framework that might be relevant barriers.")}</label>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 mt-2" id="tdf-domains-checkboxes">
                                ${tdfDomains.map(d => `<label class="flex items-center space-x-2 p-2 bg-gray-50 rounded-md"><input type="checkbox" name="tdf" value="${d}"><span>${d}</span></label>`).join('')}
                            </div>
                        </div>
                        <div>
                            <label class="block font-semibold">Potential Strategies ${createInfoTip("Based on the diagnosis, what types of strategies (e.g., Education, Training, Persuasion) and specific techniques might work?")}</label>
                            <textarea id="bct-notes" rows="3" placeholder="e.g., Education (provide information), Persuasion (use opinion leaders), Training (practice and feedback)..."></textarea>
                        </div>
                    </div>
                    <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('behavioral-diagnosis')">Save and Mark as Complete</button>
                    </div>
                </div>`;
        }
        
        // --- MODULE: Fidelity Planner ---
        function renderFidelityPlanner() {
            const container = document.getElementById('page-fidelity-planner');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Plan for Fidelity</h1>
                    <p class="text-text-light mb-6">Define the core components of the practice (from the 'Define the Project' module) and plan how to measure if they are delivered as intended.</p>
                    <div id="fidelity-plan-container" class="space-y-4"></div>
                    <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('fidelity-planner')">Save and Mark as Complete</button>
                    </div>
                </div>`;
            renderFidelityComponentRows();
        }

        function renderFidelityComponentRows() {
            const container = document.getElementById('fidelity-plan-container');
            if (!container) return;
            const coreComponents = projectData.usableInnovation.components.filter(c => c.type === 'core');
            if (coreComponents.length === 0) {
                container.innerHTML = `<p class="text-center text-text-light p-4 bg-bg-light rounded-md">No 'Core' components defined yet. Go to the "Define the Project" module to add some.</p>`;
                return;
            }
            const fidelityDimensions = ["Adherence", "Dose", "Quality of Delivery", "Participant Responsiveness", "Program Differentiation"];
            container.innerHTML = coreComponents.map(component => `
                <details class="border rounded-lg bg-bg-light">
                    <summary class="p-4 font-semibold text-lg flex justify-between items-center">${component.name}<svg class="details-caret h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></summary>
                    <div class="p-4 border-t bg-white space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div><label class="block font-semibold text-sm">Fidelity Dimension</label><select class="w-full mt-1" onchange="updateFidelityComponent(${component.id}, 'dimension', this.value)"><option value="">Select...</option>${fidelityDimensions.map(d => `<option value="${d}" ${component.dimension === d ? 'selected' : ''}>${d}</option>`).join('')}</select></div>
                            <div><label class="block font-semibold text-sm">Fidelity Target</label><input type="text" class="w-full mt-1" value="${component.target || ''}" onchange="updateFidelityComponent(${component.id}, 'target', this.value)" placeholder="e.g., >90% of steps completed"></div>
                        </div>
                        <div><label class="block font-semibold text-sm">Measurement Method</label><textarea class="w-full mt-1" rows="2" onchange="updateFidelityComponent(${component.id}, 'measurement', this.value)" placeholder="e.g., Direct observation checklist, review of session notes, user-reported completion.">${component.measurement || ''}</textarea></div>
                    </div>
                </details>
            `).join('');
        }

        function updateFidelityComponent(id, field, value) {
            const component = projectData.usableInnovation.components.find(c => c.id === id);
            if (component) {
                component[field] = value;
            }
        }
        
        // --- MODULE: Costing Planner ---
        function renderCostingPlanner() {
            const container = document.getElementById('page-costing-planner');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Plan for Costs</h1>
                    <p class="text-text-light mb-6">Use activity-based costing to plan and budget for implementation strategies.</p>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold section-title">Costing Activities</h2>
                        <button class="btn btn-secondary" onclick="addCostingActivity()">Add Activity</button>
                    </div>
                    <div id="costing-log" class="space-y-4"></div>
                    <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('costing-planner')">Save and Mark as Complete</button>
                    </div>
                </div>`;
            renderCostingLog();
        }
        function renderCostingLog() {
            const container = document.getElementById('costing-log');
            if(!container) return;
            if(projectData.costingPlan.activities.length === 0) {
                container.innerHTML = `<p class="text-center text-text-light p-4 bg-bg-light rounded-md">No costing activities logged yet.</p>`;
                return;
            }
            container.innerHTML = projectData.costingPlan.activities.map(act => `
                <div class="bg-bg-light p-4 rounded-lg border">
                    <div class="flex justify-end"><button class="text-red-500 hover:text-red-700 font-semibold text-xl" onclick="deleteCostingActivity(${act.id})">&times;</button></div>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label class="block font-semibold text-sm">Implementation Strategy/Activity</label><input type="text" value="${act.name}" onchange="updateCostingActivity(${act.id}, 'name', this.value)"></div>
                        <div><label class="block font-semibold text-sm">Estimated Cost ($)</label><input type="number" value="${act.cost}" onchange="updateCostingActivity(${act.id}, 'cost', this.value)"></div>
                    </div>
                    <div class="mt-3"><label class="block font-semibold text-sm">Costing Notes (Labor, Materials, etc.)</label><textarea rows="2" onchange="updateCostingActivity(${act.id}, 'notes', this.value)">${act.notes}</textarea></div>
                </div>
            `).join('');
        }
        function addCostingActivity() {
            projectData.costingPlan.activities.push({id: Date.now(), name: "New Activity", cost: 0, notes: ""});
            renderCostingLog();
        }
        function updateCostingActivity(id, field, value) {
            const act = projectData.costingPlan.activities.find(a => a.id === id);
            if(act) act[field] = value;
        }
        function deleteCostingActivity(id) {
            projectData.costingPlan.activities = projectData.costingPlan.activities.filter(a => a.id !== id);
            renderCostingLog();
        }

        // --- MODULE: Drivers Planner ---
        function renderDriversPlanner() {
            const container = document.getElementById('page-drivers-planner');
            const d = projectData.drivers;
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Plan for Support</h1>
                    <p class="text-text-light mb-6">Plan for the core supports needed to help people use the new practice correctly and consistently.</p>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-xl font-semibold section-title mb-4">Competency Drivers</h3>
                            <div class="space-y-4 pl-4 border-l-2 border-border-color">
                                <div><label class="block font-semibold text-sm">Selection ${createInfoTip("How will the right staff be selected?")}</label><textarea rows="3" onchange="d.selection = this.value" placeholder="e.g., Criteria for new hires, interviews...">${d.selection}</textarea></div>
                                <div><label class="block font-semibold text-sm">Training ${createInfoTip("What initial training will be provided?")}</label><textarea rows="3" onchange="d.training = this.value" placeholder="e.g., Workshop, online modules...">${d.training}</textarea></div>
                                <div><label class="block font-semibold text-sm">Coaching ${createInfoTip("What is the plan for ongoing coaching and feedback?")}</label><textarea rows="3" onchange="d.coaching = this.value" placeholder="e.g., Peer coaching, expert consultation...">${d.coaching}</textarea></div>
                            </div>
                        </div>
                         <div>
                            <h3 class="text-xl font-semibold section-title mb-4">Organizational Drivers</h3>
                            <div class="space-y-4 pl-4 border-l-2 border-border-color">
                                <div><label class="block font-semibold text-sm">Data Systems ${createInfoTip("What data systems are needed to monitor progress?")}</label><textarea rows="3" onchange="d.dataSystems = this.value" placeholder="e.g., EHR modifications, new dashboards...">${d.dataSystems}</textarea></div>
                                <div><label class="block font-semibold text-sm">Administrative Support ${createInfoTip("What administrative supports or policy changes are required?")}</label><textarea rows="3" onchange="d.adminSupport = this.value" placeholder="e.g., Changes to job descriptions, new billing codes...">${d.adminSupport}</textarea></div>
                                <div><label class="block font-semibold text-sm">System-level Adjustments ${createInfoTip("How will the system be adjusted to support the new way of work?")}</label><textarea rows="3" onchange="d.systemAdjustments = this.value" placeholder="e.g., Changes to workflow, referral processes...">${d.systemAdjustments}</textarea></div>
                            </div>
                        </div>
                         <div>
                            <h3 class="text-xl font-semibold section-title mb-4">Leadership Drivers</h3>
                            <div class="space-y-4 pl-4 border-l-2 border-border-color">
                                <div><label class="block font-semibold text-sm">Technical Leadership ${createInfoTip("Managing the project's timelines, resources, and tasks.")}</label><textarea rows="3" onchange="d.technicalLeadership = this.value" placeholder="e.g., Project management, regular check-ins...">${d.technicalLeadership}</textarea></div>
                                <div><label class="block font-semibold text-sm">Adaptive Leadership ${createInfoTip("Helping people through the change, addressing challenges, and modeling commitment.")}</label><textarea rows="3" onchange="d.adaptiveLeadership = this.value" placeholder="e.g., Communicating the vision, celebrating wins...">${d.adaptiveLeadership}</textarea></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('drivers-planner')">Save and Mark as Complete</button>
                    </div>
                </div>`;
        }

        // --- MODULE: Adaptations Tracker ---
        function renderAdaptationsTracker() {
            const container = document.getElementById('page-adaptations-tracker');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Track Changes</h1>
                    <p class="text-text-light mb-6">Document any modifications made to the new practice or support strategies using the FRAME or FRAME-IS frameworks.</p>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold section-title">Log of Changes</h2>
                        <button class="btn btn-secondary" onclick="openAdaptationModal()">Log a New Change</button>
                    </div>
                    <div id="adaptation-log" class="space-y-4"></div>
                    <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('adaptations-tracker')">Save and Mark as Complete</button>
                    </div>
                </div>`;
            renderAdaptationLog();
        }

        function renderAdaptationLog() {
            const container = document.getElementById('adaptation-log');
            if (!container) return;
            if (projectData.adaptations.length === 0) {
                container.innerHTML = `<p class="text-center text-text-light p-4 bg-bg-light rounded-md">No changes logged yet.</p>`;
                return;
            }
            container.innerHTML = projectData.adaptations.map(a => `
                <div class="bg-bg-light p-4 rounded-lg border border-border-color cursor-pointer" onclick="openAdaptationModal(${a.id})">
                    <p class="font-bold section-title">${a.data['What was modified?'] || 'Adaptation'}</p>
                    <p class="text-sm text-text-light">Logged on ${new Date(a.date).toLocaleDateString()} using ${a.framework.toUpperCase()}</p>
                </div>
            `).join('');
        }

        function openAdaptationModal(id = null) {
            const adaptation = id ? projectData.adaptations.find(a => a.id === id) : null;
            const isNew = !adaptation;
            const framework = adaptation ? adaptation.framework : 'frame';
            const data = adaptation ? adaptation.data : {};

            const frameworks = {
                frame: {
                    title: "FRAME (for changes to the practice itself)",
                    sections: [
                        { name: "When and How", fields: [{label: "Date of Modification", type: "date"}, {label: "Was the modification planned or unplanned?", type: "select", options: ["Planned", "Unplanned"] }] },
                        { name: "What was Modified", fields: [{label: "What was modified?", type: "text", placeholder: "e.g., Added a component, changed delivery format" }, {label: "Nature of the content modification", type: "textarea" }] },
                        { name: "Who Participated", fields: [{label: "Who participated in the decision to modify?", type: "textarea" }] },
                        { name: "Reasons for Modification", fields: [{label: "What were the reasons for the modification?", type: "textarea" }] }
                    ]
                },
                'frame-is': {
                    title: "FRAME-IS (for changes to support strategies)",
                    sections: [
                        { name: "Core", fields: [{label: "Support strategy that was modified", type: "text"}, {label: "What was modified for the support strategy?", type: "textarea"}] },
                        { name: "Context", fields: [{label: "What were the reasons for the modification?", type: "textarea"}, {label: "What contextual factors influenced the modification?", type: "textarea"}] }
                    ]
                }
            };

            const selectedFramework = frameworks[framework];

            let formHTML = selectedFramework.sections.map(section => `
                <fieldset class="border-t pt-4 mt-4"><legend class="font-semibold text-lg section-title">${section.name}</legend><div class="space-y-4 mt-2">
                ${section.fields.map(field => {
                    const value = data[field.label] || '';
                    let inputHtml = '';
                    switch(field.type) {
                        case 'date': inputHtml = `<input type="date" name="${field.label}" value="${value || new Date().toISOString().split('T')[0]}">`; break;
                        case 'select': inputHtml = `<select name="${field.label}">${field.options.map(opt => `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`).join('')}</select>`; break;
                        case 'textarea': inputHtml = `<textarea name="${field.label}" rows="3" placeholder="${field.placeholder || ''}">${value}</textarea>`; break;
                        default: inputHtml = `<input type="text" name="${field.label}" placeholder="${field.placeholder || ''}" value="${value}">`;
                    }
                    return `<div><label class="block text-sm font-medium mb-1">${field.label}</label>${inputHtml}</div>`;
                }).join('')}
                </div></fieldset>`).join('');

            const modalHTML = `
                <div id="adaptation-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-[100]">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto"><form id="adaptation-form">
                        <div class="p-6 border-b"><h2 class="text-2xl font-bold page-title">${isNew ? 'Log New' : 'Edit'} Change</h2></div>
                        <div class="p-6 space-y-4">
                            <input type="hidden" id="adaptation-id" value="${id || ''}">
                            <div><label class="block font-semibold">Framework</label><select id="adaptation-framework-select" onchange="openAdaptationModal(${id})"><option value="frame" ${framework === 'frame' ? 'selected' : ''}>FRAME</option><option value="frame-is" ${framework === 'frame-is' ? 'selected' : ''}>FRAME-IS</option></select></div>
                            <p class="text-sm text-text-light">${selectedFramework.title}</p>
                            ${formHTML}
                        </div>
                        <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3">
                            <button type="button" class="btn bg-gray-200 text-gray-700" onclick="closeModal('adaptation-modal')">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveAdaptation()">${isNew ? 'Save' : 'Update'}</button>
                        </div>
                    </form></div>
                </div>`;
            document.getElementById('modal-container').innerHTML = modalHTML;
        }

        function saveAdaptation() {
            const form = document.getElementById('adaptation-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const id = document.getElementById('adaptation-id').value;
            const framework = document.getElementById('adaptation-framework-select').value;
            
            if (id) { // Update
                const index = projectData.adaptations.findIndex(a => a.id == id);
                projectData.adaptations[index] = { ...projectData.adaptations[index], framework, data };
            } else { // Create
                projectData.adaptations.push({ id: Date.now(), framework, date: new Date().toISOString(), data });
            }
            renderAdaptationLog();
            closeModal('adaptation-modal');
        }
        
        // --- MODULE: PDSA Tracker ---
        function renderPDSATracker() {
            const container = document.getElementById('page-pdsa-tracker');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Test & Refine (PDSA)</h1>
                    <p class="text-text-light mb-6">Plan, test, and learn from small-scale changes using Plan-Do-Study-Act cycles.</p>
                    <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold section-title">PDSA Log</h2><button class="btn btn-secondary" onclick="openPDSAModal()">New PDSA Cycle</button></div>
                    <div id="pdsa-log" class="space-y-4"></div>
                    <div class="mt-8 border-t pt-6 flex justify-end"><button class="btn btn-primary" onclick="saveModule('pdsa-tracker')">Save and Mark as Complete</button></div>
                </div>`;
            renderPDSALog();
        }
        
        function renderPDSALog() {
            const container = document.getElementById('pdsa-log');
            if(!container) return;
            if(projectData.pdsaCycles.length === 0) {
                container.innerHTML = `<p class="text-center text-text-light p-4 bg-bg-light rounded-md">No PDSA cycles logged yet.</p>`;
                return;
            }
            container.innerHTML = projectData.pdsaCycles.map(cycle => `
                <details class="bg-bg-light border rounded-lg"><summary class="p-4 font-semibold flex justify-between items-center"><span>Cycle for: ${cycle.plan.split(' ').slice(0,5).join(' ')}...</span><span class="text-sm text-text-light">${new Date(cycle.date).toLocaleDateString()}</span></summary>
                <div class="p-4 border-t space-y-3">
                    <div><h4 class="font-bold">Plan:</h4><p>${cycle.plan}</p></div>
                    <div><h4 class="font-bold">Do:</h4><p>${cycle.do}</p></div>
                    <div><h4 class="font-bold">Study:</h4><p>${cycle.study}</p></div>
                    <div><h4 class="font-bold">Act:</h4><p>${cycle.act}</p></div>
                </div></details>`).join('');
        }

        function openPDSAModal() {
            const modalHTML = `
                <div id="pdsa-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-[100]">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl"><div class="p-6 border-b"><h2 class="text-2xl font-bold page-title">New PDSA Cycle</h2></div>
                    <div class="p-6 space-y-4">
                        <div><label class="block font-semibold">Plan ${createInfoTip("What change will be tested? Who will be involved? What is the prediction?")}</label><textarea id="pdsa-plan" rows="3"></textarea></div>
                        <div><label class="block font-semibold">Do ${createInfoTip("Carry out the test. Document problems and unexpected observations.")}</label><textarea id="pdsa-do" rows="3"></textarea></div>
                        <div><label class="block font-semibold">Study ${createInfoTip("Analyze the data. Compare results to predictions. Summarize what was learned.")}</label><textarea id="pdsa-study" rows="3"></textarea></div>
                        <div><label class="block font-semibold">Act ${createInfoTip("What's next? Adopt the change, adapt it, or abandon it? What is the plan for the next cycle?")}</label><textarea id="pdsa-act" rows="3"></textarea></div>
                    </div>
                    <div class="p-4 bg-gray-50 border-t flex justify-end space-x-3"><button type="button" class="btn bg-gray-200 text-gray-700" onclick="closeModal('pdsa-modal')">Cancel</button><button type="button" class="btn btn-primary" onclick="savePDSACycle()">Save Cycle</button></div>
                    </div></div>`;
            document.getElementById('modal-container').innerHTML = modalHTML;
            addInfoTipListeners();
        }

        function savePDSACycle() {
            const plan = document.getElementById('pdsa-plan').value;
            if(!plan.trim()) { alert("The 'Plan' section is required."); return; }
            projectData.pdsaCycles.push({
                id: Date.now(), date: new Date().toISOString(),
                plan: plan, do: document.getElementById('pdsa-do').value,
                study: document.getElementById('pdsa-study').value, act: document.getElementById('pdsa-act').value
            });
            renderPDSALog();
            closeModal('pdsa-modal');
        }

        // --- MODULE: Outcomes Planner ---
        function renderOutcomesPlanner() {
            const container = document.getElementById('page-outcomes-planner');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Define & Measure Success</h1>
                    <p class="text-text-light mb-6">Define what success looks like at different levels and create a plan to measure it.</p>
                    
                    <h2 class="text-2xl font-bold section-title mt-8 mb-4">What Success Looks Like (Proctor Outcomes)</h2>
                    <div class="grid md:grid-cols-3 gap-6" id="logic-model-container"></div>

                    <h2 class="text-2xl font-bold section-title mt-8 mb-4">How to Measure It (RE-AIM Framework)</h2>
                    <div id="reaim-accordion" class="space-y-2"></div>

                    <div class="mt-8 border-t pt-6 flex justify-end"><button class="btn btn-primary" onclick="saveModule('outcomes-planner')">Save and Mark as Complete</button></div>
                </div>`;
            renderLogicModel();
            renderReAimPlanner();
        }

        function renderLogicModel() {
            const container = document.getElementById('logic-model-container');
            const outcomeTypes = { implementation: "Implementation Outcomes", service: "Service Outcomes", client: "Client Outcomes" };
            container.innerHTML = Object.keys(outcomeTypes).map(type => `
                <div class="bg-bg-light p-4 rounded-lg">
                    <h3 class="font-bold text-lg section-title mb-3">${outcomeTypes[type]}</h3>
                    <div id="logic-${type}-list" class="space-y-2 mb-3">
                        ${projectData.outcomes.logicModel[type].map((item, index) => `<div class="bg-white p-2 rounded border flex justify-between items-center"><span>${item}</span><button class="text-red-500 font-bold" onclick="deleteLogicModelItem('${type}', ${index})">&times;</button></div>`).join('')}
                    </div>
                    <div class="flex"><input type="text" id="logic-${type}-input" class="rounded-r-none"><button class="btn btn-secondary rounded-l-none text-sm" onclick="addLogicModelItem('${type}')">Add</button></div>
                </div>`).join('');
        }

        function addLogicModelItem(type) {
            const input = document.getElementById(`logic-${type}-input`);
            if(input.value.trim()) {
                projectData.outcomes.logicModel[type].push(input.value.trim());
                input.value = '';
                renderLogicModel();
            }
        }

        function deleteLogicModelItem(type, index) {
            projectData.outcomes.logicModel[type].splice(index, 1);
            renderLogicModel();
        }

        function renderReAimPlanner() {
            const container = document.getElementById('reaim-accordion');
            const reAimDimensions = {
                reach: "Who is the intended audience, and how many of them will be exposed to the intervention?",
                effectiveness: "What is the impact of the intervention on important outcomes, including potential negative effects?",
                adoption: "How many settings and staff will agree to use the new practice?",
                implementation: "To what extent is the intervention delivered as intended (fidelity)? What are the costs?",
                maintenance: "To what extent is the practice sustained over time at both the individual and organizational levels?"
            };
            container.innerHTML = Object.keys(reAimDimensions).map(dim => `
                <details class="border rounded-lg"><summary class="p-4 font-semibold text-lg flex justify-between items-center">${dim.charAt(0).toUpperCase() + dim.slice(1)}<svg class="details-caret h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></summary>
                <div class="p-4 border-t space-y-4"><p class="text-sm text-text-light">${reAimDimensions[dim]}</p>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div><label class="block font-semibold text-sm">Metric(s)</label><input type="text" onchange="projectData.outcomes.reAim.${dim}.metric = this.value" value="${projectData.outcomes.reAim[dim].metric}"></div>
                        <div><label class="block font-semibold text-sm">Target</label><input type="text" onchange="projectData.outcomes.reAim.${dim}.target = this.value" value="${projectData.outcomes.reAim[dim].target}"></div>
                    </div>
                    <div><label class="block font-semibold text-sm">Notes/Methods</label><textarea rows="2" onchange="projectData.outcomes.reAim.${dim}.notes = this.value">${projectData.outcomes.reAim[dim].notes}</textarea></div>
                </div></details>`).join('');
        }
        
        // --- MODULE: NPT Monitor ---
        function renderNPTMonitor() {
            const container = document.getElementById('page-npt-monitor');
            const nptConstructs = {
                coherence: "Sense-making: Do people understand the new practice, how it's different, and its value?",
                cognitiveParticipation: "Buy-in: Are key people willing to participate and support the practice?",
                collectiveAction: "Enactment: Do people have the skills and resources to do the work? Is it integrated into workflows?",
                reflexiveMonitoring: "Appraisal: Are people assessing the practice's benefits and costs and making adjustments?"
            };
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Track Long-Term Adoption (NPT)</h1>
                    <p class="text-text-light mb-6">Assess how well the new practice is becoming a normal part of everyday work.</p>
                    <div class="space-y-6">
                    ${Object.keys(nptConstructs).map(key => `
                        <div><h3 class="text-xl font-semibold section-title">${key.charAt(0).toUpperCase() + key.slice(1)}</h3>
                        <p class="text-sm text-text-light mb-2">${nptConstructs[key]}</p>
                        <textarea rows="4" onchange="projectData.nptAssessment.${key} = this.value" placeholder="Qualitative notes on ${key}...">${projectData.nptAssessment[key]}</textarea></div>
                    `).join('')}
                    </div>
                    <div class="mt-8 border-t pt-6 flex justify-end"><button class="btn btn-primary" onclick="saveModule('npt-monitor')">Save and Mark as Complete</button></div>
                </div>`;
        }
        
        // --- MODULE: Sustainment Planner ---
        function renderSustainmentPlanner() {
            const container = document.getElementById('page-sustainment-planner');
            const plan = projectData.sustainmentPlan;
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Plan for the Future</h1>
                    <p class="text-text-light mb-6">Develop a plan to ensure the long-term success of the new practice.</p>
                    <div class="space-y-6">
                        <div><label class="block font-semibold text-lg section-title">Funding ${createInfoTip("How will the new practice be funded after the initial implementation period ends? Consider grants, operational budgets, billing, etc.")}</label><textarea class="w-full mt-1" rows="4" onchange="plan.funding = this.value" placeholder="Describe the long-term funding strategy...">${plan.funding}</textarea></div>
                        <div><label class="block font-semibold text-lg section-title">Workforce & Training ${createInfoTip("How will new staff be trained? What is the plan for ongoing coaching and support for existing staff?")}</label><textarea class="w-full mt-1" rows="4" onchange="plan.workforce = this.value" placeholder="Describe the plan for training new staff and providing ongoing coaching...">${plan.workforce}</textarea></div>
                        <div><label class="block font-semibold text-lg section-title">Data & Monitoring ${createInfoTip("How will performance and outcomes be monitored over the long term? Who is responsible for reviewing this data?")}</label><textarea class="w-full mt-1" rows="4" onchange="plan.monitoring = this.value" placeholder="Describe the plan for ongoing data collection and review...">${plan.monitoring}</textarea></div>
                        <div><label class="block font-semibold text-lg section-title">Adaptation Process ${createInfoTip("What is the formal process for considering, approving, and documenting future changes to the practice?")}</label><textarea class="w-full mt-1" rows="4" onchange="plan.adaptation = this.value" placeholder="Describe the process for making future adaptations...">${plan.adaptation}</textarea></div>
                        <div><label class="block font-semibold text-lg section-title">Policy & Integration ${createInfoTip("Are there organizational policies or procedures needed to fully embed the new practice into routine operations?")}</label><textarea class="w-full mt-1" rows="4" onchange="plan.policy = this.value" placeholder="Describe necessary changes to policies and procedures...">${plan.policy}</textarea></div>
                    </div>
                    <div class="mt-8 border-t pt-6 flex justify-end"><button class="btn btn-primary" onclick="saveModule('sustainment-planner')">Save and Mark as Complete</button></div>
                </div>`;
        }
        
        // --- MODULE: Causal Pathway Diagrammer (NEW) ---
        const cpdNodeTypes={
            implementation_strategy:{label:"Strategy", width: 160, height: 80, shape: 'rectangle'},
            mechanism:{label:"Mechanism", width: 180, height: 100, shape: 'diamond'},
            determinant:{label:"Determinant", width: 150, height: 150, shape: 'octagon'},
            proximal_outcome:{label:"Proximal Outcome", width: 150, height: 150, shape: 'ellipse'},
            distal_outcome:{label:"Distal Outcome", width: 150, height: 150, shape: 'ellipse'},
            moderator:{label:"Moderator", width: 120, height: 120, shape: 'square'},
            precondition:{label:"Precondition", width: 180, height: 70, shape: 'trapezoid'}
        };
        const cpdLearningModules = {
            implementation_strategy: { title: "Implementation Strategy", definition: "Methods used to improve the adoption, fidelity, or sustained use of an evidence-based treatment, practice, or service." },
            mechanism: { title: "Mechanism", definition: "The process through which an implementation strategy operates to affect an implementation outcome." },
            determinant: { title: "Determinant", definition: "Commonly referred to as barriers or facilitators, a factor that has an enabling or hindering influence on an implementation outcome. Determinants are often the targets that implementation strategies are intended to affect." },
            proximal_outcome: { title: "Proximal Outcome", definition: "The most immediate, observable outcome of an implementation strategy. This can include mechanistic outcomes (direct results of the mechanism) and other early effects." },
            distal_outcome: { title: "Distal Implementation Outcome", definition: "The downstream implementation outcome that the implementation strategy is ultimately intended to achieve." },
            precondition: { title: "Precondition", definition: "A factor that is necessary for an implementation strategy to exert its influence on an implementation outcome." },
            moderator: { title: "Moderator", definition: "A factor that can strengthen or weaken the influence of an implementation strategy." }
        };

        function renderCausalPathwayDiagrammer() {
            const container = document.getElementById('page-causal-pathway-diagrammer');
            container.innerHTML = `
                ${createBackLink('plan')}
                ${createPreviewNotice()}
                <div class="card p-8">
                    <h1 class="text-3xl font-bold page-title mb-2">Causal Pathway Diagrammer</h1>
                    <p class="text-text-light mb-6">Drag background to pan. Drag nodes to move. Shift-drag from node to node to link. Double-click to edit text.</p>
                    <div id="cpd-container">
                        <div id="cpd-toolbar">
                            <h3>Elements</h3>
                            <div id="cpd-palette"></div>
                        </div>
                        <div id="cpd-canvas-wrapper" class="canvas-container">
                            <svg id="cpd-canvas-svg"></svg>
                            <div class="zoom-controls">
                                 <button onclick="fitCpdView()" title="Fit to View" class="bg-gray-200 w-8 h-8 rounded-full font-bold flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5M.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5m15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5"/></svg></button>
                                <button onclick="cpdZoom.scaleBy(cpdSvg.transition().duration(250), 1.2)" title="Zoom In" class="bg-gray-200 w-8 h-8 rounded-full font-bold text-lg">+</button>
                                <button onclick="cpdZoom.scaleBy(cpdSvg.transition().duration(250), 0.8)" title="Zoom Out" class="bg-gray-200 w-8 h-8 rounded-full font-bold text-lg">-</button>
                            </div>
                            <button onclick="clearCpdCanvas()" class="clear-btn bg-gray-200 text-gray-700 font-bold py-1 px-3 rounded-lg text-sm">Clear</button>
                        </div>
                    </div>
                    <div class="mt-8 border-t pt-6 flex justify-end">
                        <button class="btn btn-primary" onclick="saveModule('causal-pathway-diagrammer')">Save and Mark as Complete</button>
                    </div>
                </div>`;
            renderCpdPalette();
            initializeCpdCanvas();
            document.addEventListener('keydown', handleCpdKeyDown);
        }

        function cleanupCpdListeners() { document.removeEventListener('keydown', handleCpdKeyDown); }
        
        function deleteCpdNode(nodeId) {
            projectData.cpdNodes = projectData.cpdNodes.filter(n => n.id !== nodeId);
            projectData.cpdConnections = projectData.cpdConnections.filter(l => l.source !== nodeId && l.target !== nodeId);
            selectedCpdNodeId = null;
            updateCpdDiagram();
        }

        function handleCpdKeyDown(event) {
            if (document.getElementById('page-causal-pathway-diagrammer').classList.contains('hidden')) return;
            if (event.key === 'Delete' || event.key === 'Backspace') {
                event.preventDefault();
                if (selectedCpdNodeId) { deleteCpdNode(selectedCpdNodeId); } 
                else if (selectedCpdLinkId) {
                    projectData.cpdConnections = projectData.cpdConnections.filter(l => l.id !== selectedCpdLinkId);
                    selectedCpdLinkId = null;
                    updateCpdDiagram();
                }
            }
        }
        
        function renderCpdPalette() {
            const palette = document.getElementById('cpd-palette');
            palette.innerHTML = Object.entries(cpdNodeTypes).map(([type, {label}]) => `<button class="cpd-tool-btn" onclick="addCpdNode('${type}')" title="${cpdLearningModules[type]?.definition || ''}">${label}</button>`).join('');
        }

        function addCpdNode(type) {
            const { label, width, height } = cpdNodeTypes[type];
            const svgEl = document.getElementById('cpd-canvas-svg');
            const currentTransform = d3.zoomTransform(svgEl);
            const centerX = (svgEl.clientWidth / 2 - currentTransform.x) / currentTransform.k;
            const centerY = (svgEl.clientHeight / 2 - currentTransform.y) / currentTransform.k;
            const newNode = { id: Date.now(), type, text: `New ${label}`, width, height, x: centerX, y: centerY };
            projectData.cpdNodes.push(newNode);
            updateCpdDiagram();
        }

        function clearCpdCanvas() {
            if (window.confirm("Are you sure you want to clear the entire canvas? This cannot be undone.")) {
                projectData.cpdNodes = [];
                projectData.cpdConnections = [];
                updateCpdDiagram();
            }
        }
        
        function fitCpdView() {
            if (projectData.cpdNodes.length === 0) return;
            const svgNode = cpdSvg.node();
            const svgWidth = svgNode.clientWidth;
            const svgHeight = svgNode.clientHeight;
            
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            projectData.cpdNodes.forEach(d => {
                const halfWidth = (d.width || cpdNodeTypes[d.type].width) / 2;
                const halfHeight = (d.height || cpdNodeTypes[d.type].height) / 2;
                minX = Math.min(minX, d.x - halfWidth); minY = Math.min(minY, d.y - halfHeight);
                maxX = Math.max(maxX, d.x + halfWidth); maxY = Math.max(maxY, d.y + halfHeight);
            });

            if (!isFinite(minX)) return;
            const padding = 80;
            const viewBoxWidth = (maxX - minX) + padding;
            const viewBoxHeight = (maxY - minY) + padding;
            const scale = Math.min(svgWidth / viewBoxWidth, svgHeight / viewBoxHeight, 1.5);
            const transform = d3.zoomIdentity.translate(svgWidth / 2, svgHeight / 2).scale(scale).translate(-(minX + (maxX - minX) / 2), -(minY + (maxY - minY) / 2));
            cpdSvg.transition().duration(750).call(cpdZoom.transform, transform);
        }

        function initializeCpdCanvas() {
            cpdSvg = d3.select("#cpd-canvas-svg");
            cpdSvg.html(`<defs><marker id="arrow" viewBox="0 -5 10 10" refX="8" refY="0" markerWidth="6" markerHeight="6" orient="auto"><path d="M0,-5L10,0L0,5" fill="var(--primary-color)"></path></marker><marker id="arrow-hover" viewBox="0 -5 10 10" refX="8" refY="0" markerWidth="6" markerHeight="6" orient="auto"><path d="M0,-5L10,0L0,5" fill="var(--accent-red)"></path></marker><marker id="arrow-selected" viewBox="0 -5 10 10" refX="8" refY="0" markerWidth="6" markerHeight="6" orient="auto"><path d="M0,-5L10,0L0,5" fill="var(--accent-red)"></path></marker></defs>`);
            cpdG = cpdSvg.append("g");
            cpdG.append("g").attr("class", "links");
            cpdG.append("g").attr("class", "nodes");
            cpdZoom = d3.zoom().scaleExtent([0.1, 4]).on("zoom", (event) => cpdG.attr("transform", event.transform));
            cpdSvg.call(cpdZoom).on("dblclick.zoom", null);
            cpdSvg.on('click', (event) => { if (event.target === cpdSvg.node()) { deselectAllCpdElements(); } });
            updateCpdDiagram();
            setTimeout(fitCpdView, 100);
        }

        function deselectAllCpdElements() {
            selectedCpdNodeId = null;
            selectedCpdLinkId = null;
            cpdG.selectAll('.selected').classed('selected', false);
        }

        function updateCpdDiagram() {
            if (!cpdG) return;
            projectData.cpdConnections.forEach(l => { if (!l.id) l.id = `link-${l.source}-${l.target}-${Math.random()}`; });
            const link = cpdG.select(".links").selectAll(".cpd-link-group").data(projectData.cpdConnections, d => d.id);
            link.exit().remove();
            const linkEnter = link.enter().append("g").attr("class", "cpd-link-group");
            linkEnter.append("path").attr("class", "cpd-link");
            linkEnter.append("path").attr("class", "cpd-link-hitbox");
            const linkUpdate = link.merge(linkEnter);
            linkUpdate.on("click", function (event, d) { event.stopPropagation(); deselectAllCpdElements(); selectedCpdLinkId = d.id; d3.select(this).classed('selected', true); });
            const node = cpdG.select(".nodes").selectAll(".cpd-node").data(projectData.cpdNodes, d => d.id);
            node.exit().remove();
            const nodeEnter = node.enter().append("g").attr("class", "cpd-node")
                .on('click', function(event, d) { event.stopPropagation(); deselectAllCpdElements(); selectedCpdNodeId = d.id; d3.select(this).classed('selected', true); })
                .on('dblclick', (event, d) => { event.stopPropagation(); const newText = prompt("Edit element text:", d.text); if (newText !== null) { d.text = newText; updateCpdDiagram(); } });
            nodeEnter.append("path").attr("class", "cpd-node-shape");
            nodeEnter.append("text").attr("class", "cpd-node-text");
            const deleteBtn = nodeEnter.append('g').attr('class', 'cpd-delete-btn').on('click', (event, d) => { event.stopPropagation(); deleteCpdNode(d.id); });
            deleteBtn.append('circle').attr('r', 9).attr('fill', 'var(--accent-red)').attr('stroke', 'white');
            deleteBtn.append('text').attr('x', 0).attr('y', 0.5).attr('text-anchor', 'middle').attr('dominant-baseline', 'middle').attr('fill', 'white').style('font-size', '14px').style('font-weight', 'bold').text('√ó');
            const allNodes = node.merge(nodeEnter);
            allNodes.attr('transform', d => `translate(${d.x},${d.y})`);
            allNodes.select(".cpd-node-shape").attr("d", d => getNodePath(d));
            allNodes.select(".cpd-delete-btn").attr('transform', d => `translate(${d.width/2}, ${-d.height/2})`);
            allNodes.select(".cpd-node-text").each(function(d) {
                const text = d3.select(this);
                text.selectAll("tspan").remove();
                const lines = wrapText(d.text, d.width);
                lines.forEach((line, i) => { text.append("tspan").attr("x", 0).attr("dy", i === 0 ? `-${(lines.length-1)*0.6}em` : '1.2em').text(line); });
            });
            let dragStartNode = null;
            let tempLinkPath = null;
            allNodes.call(d3.drag()
                .on("start", function(event, d) {
                    d3.select(this).raise();
                    if (event.sourceEvent.shiftKey) {
                        dragStartNode = d;
                        const startPoint = getAnchorPoint(d, 'right');
                        tempLinkPath = cpdG.select(".links").append("path").attr("class", "cpd-link").style("stroke-dasharray", "5, 5").attr("marker-end", "url(#arrow)").attr("d", `M${startPoint.x},${startPoint.y}L${startPoint.x},${startPoint.y}`);
                    }
                })
                .on("drag", function(event, d) {
                    if (tempLinkPath) {
                        const startPoint = getAnchorPoint(dragStartNode, 'right');
                        tempLinkPath.attr("d", `M${startPoint.x},${startPoint.y}L${event.x},${event.y}`);
                    } else {
                        d.x = event.x; d.y = event.y;
                        updateCpdDiagram();
                    }
                })
                .on("end", function(event, d) {
                    if (tempLinkPath) {
                        tempLinkPath.remove(); tempLinkPath = null;
                        const endNodeEl = event.sourceEvent.target.closest('.cpd-node');
                        if (endNodeEl) {
                            const endNode = d3.select(endNodeEl).datum();
                            if (endNode && endNode.id !== dragStartNode.id) {
                                const linkExists = projectData.cpdConnections.some(l => (l.source === dragStartNode.id && l.target === endNode.id));
                                if (!linkExists) { projectData.cpdConnections.push({ source: dragStartNode.id, target: endNode.id }); updateCpdDiagram(); }
                            }
                        }
                    }
                    dragStartNode = null;
                }));
            linkUpdate.selectAll('.cpd-link, .cpd-link-hitbox').attr('d', d => {
                const sourceNode = projectData.cpdNodes.find(n => n.id === d.source);
                const targetNode = projectData.cpdNodes.find(n => n.id === d.target);
                if (!sourceNode || !targetNode) return "";
                const { start, end } = getLinkEndPoints(sourceNode, targetNode);
                return `M ${start.x} ${start.y} L ${end.x} ${end.y}`;
            });
        }
        
        function getNodePath(node) {
            const w = node.width, h = node.height; const x = -w / 2, y = -h / 2; const r = 12;
            switch(cpdNodeTypes[node.type].shape) {
                case 'rectangle': return `M${x+r},${y} h${w-2*r} a${r},${r} 0 0 1 ${r},${r} v${h-2*r} a${r},${r} 0 0 1 -${r},${r} h-${w-2*r} a${r},${r} 0 0 1 -${r},-${r} v-${h-2*r} a${r},${r} 0 0 1 ${r},-${r} z`;
                case 'diamond': return `M0,${y} L${x+w},0 L0,${y+h} L${x},0 Z`;
                case 'octagon': const octSideRatio = 0.4142; const cornerX = w / 2 * octSideRatio; const cornerY = h / 2 * octSideRatio; return `M ${x+cornerX},${y} L ${x+w-cornerX},${y} L ${x+w},${y+cornerY} L ${x+w},${y+h-cornerY} L ${x+w-cornerX},${y+h} L ${x+cornerX},${y+h} L ${x},${y+h-cornerY} L ${x},${y+cornerY} Z`;
                case 'ellipse': return `M${x},0 a${w/2},${h/2} 0 1,0 ${w},0 a${w/2},${h/2} 0 1,0 -${w},0`;
                case 'square': return `M${x},${y} h${w} v${h} h-${w} z`;
                case 'trapezoid': return `M${x},${y+h} l${w*0.15},-${h} h${w*0.7} l${w*0.15},${h} z`;
                default: return `M${x},${y} h${w} v${h} h-${w} z`;
            }
        }
        
        function getAnchorPoint(node, direction) {
            switch(direction) {
                case 'top': return { x: node.x, y: node.y - node.height / 2 };
                case 'bottom': return { x: node.x, y: node.y + node.height / 2 };
                case 'left': return { x: node.x - node.width / 2, y: node.y };
                case 'right': return { x: node.x + node.width / 2, y: node.y };
                default: return { x: node.x, y: node.y };
            }
        }

        function getLinkEndPoints(source, target) {
            let startDir = 'right', endDir = 'left';
            if (source.type === 'moderator' || source.type === 'precondition') { startDir = 'bottom'; }
            if (target.type === 'moderator' || target.type === 'precondition') { endDir = 'top'; }
            if ((source.type === 'implementation_strategy' && target.type === 'moderator') || (source.type === 'moderator' && target.type === 'implementation_strategy')) { startDir = 'top'; endDir = 'bottom'; }
            if (source.x > target.x) { [startDir, endDir] = ['left', 'right']; }
            const verticalThreshold = 50;
            if (Math.abs(source.x - target.x) < verticalThreshold) { if (source.y < target.y) { [startDir, endDir] = ['bottom', 'top']; } else { [startDir, endDir] = ['top', 'bottom']; } }
            return { start: getAnchorPoint(source, startDir), end: getAnchorPoint(target, endDir) };
        }

        function wrapText(text, width) {
            if (!text) return [""];
            const words = text.split(/\s+/).reverse(); let word; const lines = []; let line = [];
            const maxWidth = width * 0.8; 
            const svg = d3.select(document.createElementNS("http://www.w3.org/2000/svg", "svg"));
            const textEl = svg.append("text").attr("class", "cpd-node-text");
            while (word = words.pop()) {
                line.push(word);
                textEl.text(line.join(" "));
                if (textEl.node().getComputedTextLength() > maxWidth && line.length > 1) { line.pop(); lines.push(line.join(" ")); line = [word]; }
            }
            lines.push(line.join(" "));
            return lines;
        }

        // --- DASHBOARD, LEARN, UTILITIES ---
        function renderDashboard() {
            const container = document.getElementById('dashboard');
            const completedModules = Object.values(projectData.projectStatus).filter(s => s === 'complete').length;
            const totalModules = Object.keys(projectData.projectStatus).length;
            const strongBarriers = Object.values(projectData.cfirAssessment.ratings).filter(r => r.valence <= -1).length;

            container.innerHTML = `
                <h1 class="text-4xl font-bold text-center page-title mb-10">Project Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="card p-4"><h3 class="font-semibold text-text-light">Plan Progress</h3><p class="text-3xl font-bold section-title">${completedModules} / ${totalModules}</p></div>
                    <div class="card p-4"><h3 class="font-semibold text-text-light">Strong Barriers (CFIR)</h3><p class="text-3xl font-bold section-title">${strongBarriers}</p></div>
                    <div class="card p-4"><h3 class="font-semibold text-text-light">Changes Logged</h3><p class="text-3xl font-bold section-title">${projectData.adaptations.length}</p></div>
                    <div class="card p-4"><h3 class="font-semibold text-text-light">Test Cycles Run</h3><p class="text-3xl font-bold section-title">${projectData.pdsaCycles.length}</p></div>
                </div>
                <div class="mt-8 card p-6">
                    <h2 class="text-2xl font-bold section-title mb-4">Connecting the Dots</h2>
                    <p class="text-text-light mb-4">This section illustrates how the different parts of the plan connect to each other.</p>
                    <div class="bg-bg-light p-4 rounded-lg border"><p>A <strong>Barrier</strong> identified like <span class="font-semibold page-title">"Low Staff Buy-in"</span>...</p><p class="ml-4">...can be addressed by a <strong>Support Plan</strong> activity such as <span class="font-semibold page-title">"Engage Opinion Leaders"</span>...</p><p class="ml-8">...which is expected to improve a <strong>Success Metric</strong> like <span class="font-semibold page-title">"Higher Adoption Rate"</span>.</p></div>
                    <div class="bg-bg-light p-4 rounded-lg border mt-4"><h4 class="font-semibold">Early Alerts (Example)</h4><p class="text-sm text-yellow-700 mt-2"><strong>Alert:</strong> Low scores on 'Acceptability' and 'Feasibility' are predictive of poor 'Fidelity' (how closely the practice is followed). Consider revisiting the Project Definition or Support Plan.</p></div>
                </div>`;
        }
        
        // --- LEARN TAB ---
        function showLearnPage(pageName) {
            const learnContainer = document.getElementById('learn');
            learnContainer.innerHTML = ''; // Clear the hub
            switch(pageName) {
                case 'foundations': renderLearnFoundations(); break;
                case 'tmfs': renderLearnTMFs(); break;
                case 'strategies': renderLearnStrategies(); break;
                case 'outcomes': renderLearnOutcomes(); break;
            }
        }

        function renderLearn() { 
            const container = document.getElementById('learn');
            container.innerHTML = `
                <h1 class="text-4xl font-bold text-center page-title mb-4">Learn Hub</h1>
                <p class="text-center text-text-light mb-10 max-w-3xl mx-auto">Explore these modules to build knowledge of implementation science concepts, frameworks, and methods.</p>
                <div id="learn-nav-container" class="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto">
                    <div class="card learn-card cursor-pointer p-6" onclick="showLearnPage('foundations')">
                        <h3 class="font-bold text-xl section-title">IS Foundations</h3>
                        <p class="text-text-light mt-2">Start here. Learn why implementation science exists, what it is, and its core language.</p>
                    </div>
                    <div class="card learn-card cursor-pointer p-6" onclick="showLearnPage('tmfs')">
                        <h3 class="font-bold text-xl section-title">Theories, Models & Frameworks (TMFs)</h3>
                        <p class="text-text-light mt-2">Explore the conceptual toolkit of IS. Learn to select the right TMF for the purpose.</p>
                    </div>
                    <div class="card learn-card cursor-pointer p-6" onclick="showLearnPage('strategies')">
                        <h3 class="font-bold text-xl section-title">Implementation Strategies (ERIC)</h3>
                        <p class="text-text-light mt-2">Discover the "how-to" of implementation. Browse a library of 73 evidence-based strategies.</p>
                    </div>
                    <div class="card learn-card cursor-pointer p-6" onclick="showLearnPage('outcomes')">
                        <h3 class="font-bold text-xl section-title">Measuring Success</h3>
                        <p class="text-text-light mt-2">Understand how to measure what matters. Learn the key outcomes for evaluating implementation.</p>
                    </div>
                </div>
                <div id="learn-content-area" class="mt-8"></div>
            `;
        }

        function renderLearnFoundations() {
            const container = document.getElementById('learn');
            container.innerHTML = `
                ${createLearnBackLink()}
                <div class="card p-8 learn-content">
                    <h1 class="text-3xl font-bold page-title mb-6">Implementation Science Foundations</h1>
                    
                    <h2>Defining the Field: The Science of Uptake</h2>
                    <p>Implementation Science (IS) is formally defined as "the scientific study of methods to promote the systematic uptake of research findings and other evidence-based practices into routine practice, and, hence, to improve the quality and effectiveness of health services".</p>
                    <blockquote>The field operates on the principle that implementation is not a simple, linear process but rather a highly complex, multi-stage, and iterative endeavor that requires intentional, explicit, and systematic effort.</blockquote>

                    <h2>Bridging the "Know-Do Gap"</h2>
                    <p>The central problem that implementation science confronts is the profound and persistent disconnect between what is known from research and what is done in routine practice. This is often called the "know-do gap".</p>
                    <p>One of the most frequently cited statistics estimates that it takes an average of <strong>17 years</strong> for new, evidence-based health practices to be incorporated into routine clinical use.</p>

                    <h2>Core Language of Implementation</h2>
                    <details class="bg-gray-50 p-4 rounded-lg">
                        <summary class="font-semibold">Dissemination vs. Implementation</summary>
                        <p class="mt-2"><strong>Dissemination</strong> refers to the targeted distribution of information. <strong>Implementation</strong> is the process of integrating a specific intervention into practice.</p>
                    </details>
                    <details class="bg-gray-50 p-4 rounded-lg mt-2">
                        <summary class="font-semibold">Adaptation vs. Fidelity</summary>
                        <p class="mt-2"><strong>Fidelity</strong> is the degree to which an intervention is implemented as intended. <strong>Adaptation</strong> refers to intentional changes made to fit the local context. The challenge is balancing both.</p>
                    </details>

                    <h2>Knowledge Check</h2>
                    <div class="interactive-quiz mt-4 p-4 border rounded-lg" id="foundations-quiz">
                        <p class="font-semibold mb-2">Which term describes the process of integrating a specific intervention into practice within an organization?</p>
                        <div class="space-y-2">
                            <div class="quiz-option" onclick="checkQuizAnswer(this, 'correct')">A) Implementation</div>
                            <div class="quiz-option" onclick="checkQuizAnswer(this, 'incorrect')">B) Dissemination</div>
                            <div class="quiz-option" onclick="checkQuizAnswer(this, 'incorrect')">C) Adaptation</div>
                        </div>
                        <p id="quiz-feedback" class="mt-3 font-semibold"></p>
                    </div>
                </div>
            `;
        }

        function renderLearnTMFs() {
            const container = document.getElementById('learn');
            container.innerHTML = `
                ${createLearnBackLink()}
                <div class="card p-8 learn-content">
                    <h1 class="text-3xl font-bold page-title mb-6">Theories, Models, & Frameworks (TMFs)</h1>
                    <h2>Why TMFs Matter: Providing Structure to Complexity</h2>
                    <p>The process of translating research into practice is inherently complex. TMFs are indispensable tools that provide a structured approach to understanding, guiding, and evaluating this complexity. They help to:</p>
                    <ul>
                        <li>Understand and explain what influences implementation outcomes.</li>
                        <li>Describe and guide the process of translating research into practice.</li>
                        <li>Provide a structure for systematically evaluating implementation.</li>
                        <li>Enhance the interpretability and generalizability of study findings.</li>
                    </ul>
                    
                    <h2>A Taxonomy of TMFs: Finding the Right Tool for the Job</h2>
                    <p>There is no single "best" TMF. The selection is purpose-driven. A useful taxonomy categorizes TMFs into five main types based on their primary aim:</p>
                    
                    <div class="grid md:grid-cols-2 gap-4 mt-6">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h3 class="text-blue-800 font-semibold">Process Models</h3>
                            <p>Describe and/or guide the process of translating research into practice. Answers: "What are the steps to follow?"<br><em>Example: EPIS Framework</em></p>
                        </div>
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <h3 class="text-green-800 font-semibold">Determinant Frameworks</h3>
                            <p>Describe factors (barriers/facilitators) that influence outcomes. Answers: "What should be expected?"<br><em>Example: CFIR</em></p>
                        </div>
                        <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                            <h3 class="text-purple-800 font-semibold">Classic Theories</h3>
                            <p>Borrowed from other disciplines to explain change. Answers: "Why do people change?"<br><em>Example: Diffusion of Innovations</em></p>
                        </div>
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <h3 class="text-yellow-800 font-semibold">Implementation Theories</h3>
                            <p>Purpose-built theories to explain implementation aspects. Answers: "How does a practice become routine?"<br><em>Example: NPT</em></p>
                        </div>
                         <div class="p-4 bg-red-50 border border-red-200 rounded-lg md:col-span-2">
                            <h3 class="text-red-800 font-semibold">Evaluation Frameworks</h3>
                            <p>Provide a structure for evaluating implementation success. Answers: "How will success be measured?"<br><em>Example: RE-AIM</em></p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLearnStrategies() {
            const container = document.getElementById('learn');
            const ericClusters = {
                "Use Evaluative and Iterative Strategies": ["Assess for readiness", "Audit and provide feedback", "Develop a formal implementation blueprint"],
                "Provide Interactive Assistance": ["Facilitation", "Provide local technical assistance", "Provide clinical supervision"],
                "Adapt and Tailor to Context": ["Tailor strategies", "Promote adaptability"],
                "Develop Stakeholder Interrelationships": ["Identify and prepare champions", "Build a coalition", "Inform local opinion leaders"],
                "Train and Educate Stakeholders": ["Conduct ongoing training", "Distribute educational materials", "Create a learning collaborative"],
                "Support Clinicians": ["Remind clinicians", "Revise professional roles", "Facilitate relay of clinical data to providers"],
                "Engage Consumers": ["Involve patients/consumers", "Increase demand", "Use mass media"],
                "Utilize Financial Strategies": ["Access new funding", "Alter incentive/allowance structures", "Develop disincentives"],
                "Change Infrastructure": ["Change record systems", "Change physical structure and equipment", "Mandate change"]
            };
            // This is a subset for demonstration. A full implementation would have all 73.
            const allStrategies = [
                { name: "Assess for readiness", cluster: "Use Evaluative and Iterative Strategies", definition: "Collecting data before implementation to determine an organization's readiness for change and to identify potential challenges and strengths." },
                { name: "Audit and provide feedback", cluster: "Use Evaluative and Iterative Strategies", definition: "Collecting and summarizing clinical performance data and giving it back to clinicians and administrators to monitor, evaluate, and modify behavior." },
                { name: "Facilitation", cluster: "Provide Interactive Assistance", definition: "A process of interactive problem-solving and support provided by a skilled individual (a facilitator) who helps an organization navigate the challenges of implementation." },
                { name: "Identify and prepare champions", cluster: "Develop Stakeholder Interrelationships", definition: "Identifying, recruiting, and supporting individuals within an organization who dedicate themselves to supporting, marketing, and driving through an implementation effort." },
                { name: "Conduct ongoing training", cluster: "Train and Educate Stakeholders", definition: "Planning for and conducting training in the EBI on an ongoing basis to reinforce skills and onboard new staff." },
                { name: "Remind clinicians", cluster: "Support Clinicians", definition: "Developing and integrating reminder systems (e.g., alerts in the EHR, checklists) designed to prompt clinicians to use the EBI at the point of care." },
                { name: "Involve patients/consumers", cluster: "Engage Consumers", definition: "Actively engaging or including consumers and their families in various aspects of the implementation effort." },
                { name: "Alter incentive/allowance structures", cluster: "Utilize Financial Strategies", definition: "Working to incentivize the adoption and implementation of the EBI, for example, through pay-for-performance programs." },
                { name: "Change record systems", cluster: "Change Infrastructure", definition: "Making changes to electronic health records or other data systems to better support the EBI." }
            ];

            container.innerHTML = `
                ${createLearnBackLink()}
                <div class="card p-8 learn-content">
                    <h1 class="text-3xl font-bold page-title mb-6">Implementation Strategies (ERIC)</h1>
                    <p>Implementation strategies are the "how-to" of creating change. The Expert Recommendations for Implementing Change (ERIC) project produced a compilation of 73 discrete strategies, organized into 9 clusters.</p>
                    
                    <div class="my-6">
                        <input type="text" id="eric-search-input" onkeyup="filterEricStrategies()" placeholder="Search for a strategy (e.g., 'feedback')...">
                    </div>

                    <div id="eric-search-results"></div>
                </div>
            `;
            
            window.filterEricStrategies = () => {
                const searchTerm = document.getElementById('eric-search-input').value.toLowerCase();
                const filtered = allStrategies.filter(s => s.name.toLowerCase().includes(searchTerm) || s.definition.toLowerCase().includes(searchTerm));
                renderEricResults(filtered);
            };

            window.renderEricResults = (strategies) => {
                const resultsContainer = document.getElementById('eric-search-results');
                if (strategies.length === 0) {
                    resultsContainer.innerHTML = `<p class="text-center text-text-light p-4">No strategies found.</p>`;
                    return;
                }
                resultsContainer.innerHTML = strategies.map(s => `
                    <div class="p-4 strategy-item">
                        <p class="font-semibold">${s.name}</p>
                        <p class="text-sm text-text-light">${s.definition}</p>
                        <p class="text-xs mt-1 font-medium text-blue-700">Cluster: ${s.cluster}</p>
                    </div>
                `).join('');
            };

            renderEricResults(allStrategies);
        }

        function renderLearnOutcomes() {
            const container = document.getElementById('learn');
            const outcomes = [
                { name: "Acceptability", def: "The perception among stakeholders that a given innovation is agreeable, palatable, or satisfactory." },
                { name: "Adoption", def: "The intention, initial decision, or action to try or employ an innovation." },
                { name: "Appropriateness", def: "The perceived fit, relevance, or compatibility of the innovation for a given setting." },
                { name: "Feasibility", def: "The extent to which an innovation can be successfully used or carried out within a given setting." },
                { name: "Fidelity", def: "The degree to which an intervention was implemented as it was prescribed." },
                { name: "Implementation Cost", def: "The cost impact of an implementation effort." },
                { name: "Penetration", def: "The integration of a practice within a service setting and its subsystems." },
                { name: "Sustainability", def: "The extent to which an innovation is maintained or institutionalized." },
            ];

            container.innerHTML = `
                ${createLearnBackLink()}
                <div class="card p-8 learn-content">
                    <h1 class="text-3xl font-bold page-title mb-6">Measuring Success: Implementation Outcomes</h1>
                    <h2>Beyond Health Outcomes</h2>
                    <p>Implementation outcomes are the effects of deliberate actions to implement new practices. They are the necessary preconditions for attaining desired health outcomes.</p>
                    <blockquote>When an EBI fails to produce the desired health outcomes, it is essential to determine the cause. Was it an <strong>intervention failure</strong>, or an <strong>implementation failure</strong>? Measuring implementation outcomes helps answer this.</blockquote>
                    
                    <h2>Proctor's Taxonomy of Implementation Outcomes</h2>
                    <p>This framework provides a common language for conceptualizing and evaluating implementation success. Click each outcome to learn more.</p>
                    <div class="space-y-2 mt-4">
                        ${outcomes.map(o => `
                            <details class="bg-gray-50 rounded-lg">
                                <summary class="p-4 font-semibold">${o.name}</summary>
                                <div class="p-4 border-t">
                                    <p>${o.def}</p>
                                </div>
                            </details>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function checkQuizAnswer(element, type) {
            const feedbackEl = document.getElementById('quiz-feedback');
            document.querySelectorAll('.quiz-option').forEach(el => {
                el.classList.remove('selected', 'correct', 'incorrect');
                el.onclick = null; // Disable further clicks
            });
            element.classList.add('selected');
            if (type === 'correct') {
                element.classList.add('correct');
                feedbackEl.textContent = "Correct! Implementation is the active process of putting an intervention into effect.";
                feedbackEl.style.color = 'var(--success-color)';
            } else {
                element.classList.add('incorrect');
                feedbackEl.textContent = "Not quite. Dissemination is about spreading information, while implementation is about active integration.";
                feedbackEl.style.color = 'var(--accent-red)';
            }
        }
        
        function saveModule(moduleId) {
            projectData.projectStatus[moduleId] = 'complete';
            showPage('plan');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.remove();
        }

        function createInfoTip(text) {
            if (!text) return '';
            return `<span class="info-tip" data-info="${text}"><svg xmlns="http://www.w3.org/2000/svg" class="info-tip-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></span>`;
        }

        function addInfoTipListeners() {
            document.querySelectorAll('.info-tip').forEach(tip => {
                tip.addEventListener('mouseover', (event) => {
                    const text = tip.dataset.info;
                    infoTooltip.html(text).style('opacity', 1).style('left', (event.pageX + 10) + 'px').style('top', (event.pageY + 10) + 'px');
                });
                tip.addEventListener('mouseout', () => { infoTooltip.style('opacity', 0); });
            });
        }
    </script>
</body>
</html>
